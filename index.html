<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מערכת ניהול אירועי בר מצווה</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.1/auth0-spa-js.production.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Varela+Round&family=Nunito:wght@300;400;500;600;700;800&display=swap');
        body { 
            font-family: 'Nunito', 'Varela Round', sans-serif; 
            font-weight: 500;
        }
        .gradient-header { background: linear-gradient(135deg, #1e3a8a 0%, #3730a3 100%); }
        .card-professional { 
            transition: all 0.3s ease; 
            border-left: 4px solid transparent;
        }
        .card-professional:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
            border-left-color: #1e3a8a;
        }
        .card-gradient-1 { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-gradient-2 { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .card-gradient-3 { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .card-gradient-4 { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .card-gradient-5 { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); }
        .card-gradient-6 { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); }
        .sidebar {
            transform: translateX(100%);
            transition: transform 0.3s ease-in-out;
        }
        .sidebar.open {
            transform: translateX(0);
        }
        .filter-btn.active {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }
        .font-hebrew {
            font-family: 'David Libre', 'Frank Ruehl CLM', 'Times New Roman', serif;
            font-size: 1.1em;
            line-height: 1.8;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Sidebar -->
    <div id="sidebar" class="sidebar fixed top-0 right-0 h-full w-80 bg-white shadow-2xl z-50 overflow-y-auto">
        <div class="p-6 border-b border-gray-200 bg-gradient-to-l from-blue-600 to-purple-600 text-white">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold">תפריט ניהול</h2>
                <button onclick="closeSidebar()" class="text-white hover:text-gray-200 text-2xl font-bold p-2 rounded-full hover:bg-white hover:bg-opacity-20 transition-all">
                    ×
                </button>
            </div>
        </div>
        
        <!-- Login Section -->
        <div class="p-4 border-b border-gray-200">
            <div id="loginSection">
                <button onclick="login()" class="w-full bg-blue-600 text-white px-3 py-2 rounded-2xl text-sm font-medium hover:bg-blue-700 transition-colors shadow-md flex items-center justify-center">
                    <span class="ml-2">🔐</span>
                    <span>כניסה למנהל</span>
                </button>
            </div>
            <div id="userInfo" class="hidden">
                <div class="bg-green-50 p-4 rounded-2xl border border-green-200">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <div class="text-green-800 font-medium">מנהל המערכת</div>
                            <div class="text-green-600 text-sm">גישה מלאה</div>
                        </div>
                        <span class="text-green-500 text-2xl">✅</span>
                    </div>
                    <button onclick="logout()" class="w-full bg-red-600 text-white px-4 py-2 rounded-2xl text-sm hover:bg-red-700 transition-colors">
                        יציאה
                    </button>
                </div>
            </div>
        </div>

        <nav class="p-4">
            <ul class="space-y-2">
                <li>
                    <button onclick="showPage('events')" class="nav-item w-full text-right p-4 rounded-2xl hover:bg-blue-50 transition-all flex items-center">
                        <span class="text-blue-500 ml-3 text-xl">📅</span>
                        <span class="font-medium">אירועים</span>
                    </button>
                </li>
                <li>
                    <button onclick="showPage('prayer-songs')" class="nav-item w-full text-right p-4 rounded-2xl hover:bg-purple-50 transition-all flex items-center">
                        <span class="text-purple-500 ml-3 text-xl">🎵</span>
                        <span class="font-medium">שירי תפילה</span>
                    </button>
                </li>
                <li>
                    <button onclick="showPage('meal-songs')" class="nav-item w-full text-right p-4 rounded-2xl hover:bg-green-50 transition-all flex items-center">
                        <span class="text-green-500 ml-3 text-xl">🍽️</span>
                        <span class="font-medium">שירי סעודה</span>
                    </button>
                </li>
                <li>
                    <button onclick="showPage('blessings')" class="nav-item w-full text-right p-4 rounded-2xl hover:bg-yellow-50 transition-all flex items-center">
                        <span class="text-yellow-500 ml-3 text-xl">🙏</span>
                        <span class="font-medium">ברכות ותפילות</span>
                    </button>
                </li>
                <li id="adminSection" class="border-t border-gray-200 pt-4 mt-4 hidden">
                    <div class="text-gray-500 text-sm font-medium mb-2 px-4">אזור אישי</div>
                    <button onclick="showPage('admin')" class="nav-item w-full text-right p-4 rounded-2xl hover:bg-orange-50 transition-all flex items-center">
                        <span class="text-orange-500 ml-3 text-xl">👤</span>
                        <span class="font-medium">ניהול תלמידים</span>
                    </button>
                    <button onclick="showPage('equipment')" class="nav-item w-full text-right p-4 rounded-2xl hover:bg-gray-50 transition-all flex items-center">
                        <span class="text-gray-500 ml-3 text-xl">📦</span>
                        <span class="font-medium">רשימת ציוד</span>
                    </button>
                    <button onclick="showPage('payments')" class="nav-item w-full text-right p-4 rounded-2xl hover:bg-green-50 transition-all flex items-center">
                        <span class="text-green-500 ml-3 text-xl">💰</span>
                        <span class="font-medium">ניהול תשלומים</span>
                    </button>
                    <button onclick="showPage('useful-links')" class="nav-item w-full text-right p-4 rounded-2xl hover:bg-indigo-50 transition-all flex items-center">
                        <span class="text-indigo-500 ml-3 text-xl">🔗</span>
                        <span class="font-medium">קישורים שימושיים</span>
                    </button>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Overlay -->
    <div id="overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40" onclick="closeSidebar()"></div>

    <!-- Header -->
    <header class="gradient-header text-white shadow-lg">
        <div class="container mx-auto px-4 sm:px-6 py-4 sm:py-6">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center">
                <div class="mb-4 sm:mb-0">
                    <h1 class="text-2xl sm:text-3xl font-bold mb-1">מערכת ניהול אירועי בר מצווה</h1>
                    <p class="text-blue-100 text-sm sm:text-lg">ניהול תפילה • לימוד • שירים ופיוטים</p>
                </div>
                <button onclick="openSidebar()" class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-2xl hover:bg-opacity-30 transition-all flex items-center">
                    <span class="ml-2">☰</span>
                    <span>תפריט</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 sm:px-6 py-6 sm:py-8">
        <!-- Events Page -->
        <div id="events-page" class="page">
            <div class="bg-white rounded-3xl shadow-lg border border-gray-100">
                <div class="bg-gradient-to-l from-blue-50 to-indigo-50 border-b border-gray-200 p-4 sm:p-6 rounded-t-3xl">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-1">אירועים קרובים</h2>
                            <p class="text-gray-600 text-sm sm:text-base">זמני הגעת האורחים וזמני תחילת האירוע</p>
                        </div>
                        <button onclick="toggleFilters()" class="bg-blue-600 text-white px-4 py-2 rounded-2xl hover:bg-blue-700 transition-all flex items-center shadow-md">
                            <span class="ml-2">🔍</span>
                            <span class="font-medium">סינון</span>
                            <span id="filterArrow" class="mr-2 transition-transform duration-300">▼</span>
                        </button>
                    </div>
                    
                    <!-- Filters Section -->
                    <div id="filtersSection" class="hidden bg-white p-4 rounded-2xl border border-blue-200 shadow-sm">
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                            <button onclick="setEventFilter('all')" id="filter-all" class="filter-btn bg-gradient-to-r from-gray-500 to-gray-600 text-white px-4 py-2 rounded-xl hover:from-gray-600 hover:to-gray-700 transition-all text-sm font-medium shadow-md">
                                📅 כל האירועים
                            </button>
                            <button onclick="setEventFilter('future')" id="filter-future" class="filter-btn bg-gradient-to-r from-green-500 to-emerald-600 text-white px-4 py-2 rounded-xl hover:from-green-600 hover:to-emerald-700 transition-all text-sm font-medium shadow-md">
                                ⏭️ עתידיים
                            </button>
                            <button onclick="setEventFilter('past')" id="filter-past" class="filter-btn bg-gradient-to-r from-red-500 to-pink-600 text-white px-4 py-2 rounded-xl hover:from-red-600 hover:to-pink-700 transition-all text-sm font-medium shadow-md">
                                ✅ הסתיימו
                            </button>
                            <button onclick="setEventFilter('keyboardist')" id="filter-keyboardist" class="filter-btn bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-2 rounded-xl hover:from-purple-600 hover:to-indigo-700 transition-all text-sm font-medium shadow-md">
                                🎹 עם קלידן
                            </button>
                            <button onclick="setEventFilter('drummers')" id="filter-drummers" class="filter-btn bg-gradient-to-r from-orange-500 to-amber-600 text-white px-4 py-2 rounded-xl hover:from-orange-600 hover:to-amber-700 transition-all text-sm font-medium shadow-md">
                                🥁 עם מתופפים
                            </button>
                            <button onclick="setEventFilter('students')" id="filter-students" class="filter-btn bg-gradient-to-r from-cyan-500 to-blue-600 text-white px-4 py-2 rounded-xl hover:from-cyan-600 hover:to-blue-700 transition-all text-sm font-medium shadow-md">
                                🎓 תלמידים
                            </button>
                        </div>
                        
                        <div class="mt-3 text-center">
                            <span id="filterStatus" class="text-sm text-gray-600 bg-gray-100 px-3 py-1 rounded-full">מציג: כל האירועים</span>
                        </div>
                    </div>
                </div>

                <div class="p-4 sm:p-6 space-y-4 sm:space-y-6" id="eventsContainer">
                    <!-- Events will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Other pages will be hidden initially -->
        <div id="prayer-songs-page" class="page hidden">
            <div class="bg-white rounded-3xl shadow-lg border border-gray-100">
                <div class="bg-gradient-to-l from-purple-50 to-pink-50 border-b border-gray-200 p-4 sm:p-6 rounded-t-3xl">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-1">שירי תפילה</h2>
                            <p class="text-gray-600 text-sm sm:text-base">רשימת השירים לחלק התפילה בבר המצווה</p>
                        </div>
                        <div class="flex bg-gray-100 rounded-xl p-1">
                            <button onclick="setPrayerViewMode('list')" id="prayerViewList" class="px-4 py-2 rounded-lg text-sm font-medium transition-all bg-purple-600 text-white">
                                📋 רשימה
                            </button>
                            <button onclick="setPrayerViewMode('categories')" id="prayerViewCategories" class="px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:text-gray-800">
                                📂 קטגוריות
                            </button>
                        </div>
                    </div>
                </div>
                <div class="p-4 sm:p-6">
                    <div id="adminPrayerButtons" class="mb-6 hidden">
                        <button onclick="showAddPrayerSongForm()" class="bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-3 rounded-2xl hover:from-purple-700 hover:to-pink-700 transition-all shadow-lg flex items-center">
                            <span class="ml-2">➕</span>
                            <span class="font-medium">הוסף שיר תפילה</span>
                        </button>
                    </div>
                    <div class="space-y-4" id="prayerSongsContainer">
                        <!-- Prayer songs will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <div id="meal-songs-page" class="page hidden">
            <div class="bg-white rounded-3xl shadow-lg border border-gray-100">
                <div class="bg-gradient-to-l from-green-50 to-emerald-50 border-b border-gray-200 p-4 sm:p-6 rounded-t-3xl">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-1">שירי סעודה</h2>
                            <p class="text-gray-600 text-sm sm:text-base">רשימת השירים לחלק הסעודה בבר המצווה</p>
                        </div>
                        <div class="flex bg-gray-100 rounded-xl p-1">
                            <button onclick="setMealViewMode('list')" id="mealViewList" class="px-4 py-2 rounded-lg text-sm font-medium transition-all bg-green-600 text-white">
                                📋 רשימה
                            </button>
                            <button onclick="setMealViewMode('categories')" id="mealViewCategories" class="px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:text-gray-800">
                                📂 קטגוריות
                            </button>
                        </div>
                    </div>
                </div>
                <div class="p-4 sm:p-6">
                    <div id="adminMealButtons" class="mb-6 hidden">
                        <button onclick="showAddMealSongForm()" class="bg-gradient-to-r from-green-600 to-emerald-600 text-white px-6 py-3 rounded-2xl hover:from-green-700 hover:to-emerald-700 transition-all shadow-lg flex items-center">
                            <span class="ml-2">➕</span>
                            <span class="font-medium">הוסף שיר סעודה</span>
                        </button>
                    </div>
                    <div class="space-y-4" id="mealSongsContainer">
                        <!-- Meal songs will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <div id="blessings-page" class="page hidden">
            <div class="bg-white rounded-3xl shadow-lg border border-gray-100">
                <div class="bg-gradient-to-l from-yellow-50 to-amber-50 border-b border-gray-200 p-4 sm:p-6 rounded-t-3xl">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-1">ברכות ותפילות</h2>
                    <p class="text-gray-600 text-sm sm:text-base">ברכות ותפילות לאירועי בר מצווה</p>
                </div>
                <div class="p-4 sm:p-6">
                    <div id="adminBlessingsButtons" class="mb-6 hidden">
                        <button onclick="showAddBlessingForm()" class="bg-gradient-to-r from-yellow-600 to-amber-600 text-white px-6 py-3 rounded-2xl hover:from-yellow-700 hover:to-amber-700 transition-all shadow-lg flex items-center">
                            <span class="ml-2">➕</span>
                            <span class="font-medium">הוסף ברכה/תפילה</span>
                        </button>
                    </div>
                    <div class="space-y-4" id="blessingsContainer">
                        <!-- Blessings will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <div id="admin-page" class="page hidden">
            <div class="bg-white rounded-3xl shadow-lg border border-gray-100">
                <div class="bg-gradient-to-l from-orange-50 to-red-50 border-b border-gray-200 p-4 sm:p-6 rounded-t-3xl">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-1">ניהול תלמידים</h2>
                    <p class="text-gray-600 text-sm sm:text-base">מעקב אחר התקדמות התלמידים</p>
                </div>
                <div class="divide-y divide-gray-200" id="studentsContainer">
                    <!-- Students will be loaded here -->
                </div>
            </div>
        </div>

        <div id="equipment-page" class="page hidden">
            <div class="bg-white rounded-3xl shadow-lg border border-gray-100">
                <div class="bg-gradient-to-l from-gray-50 to-slate-50 border-b border-gray-200 p-4 sm:p-6 rounded-t-3xl">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-1">רשימת ציוד לאירוע</h2>
                    <p class="text-gray-600 text-sm sm:text-base">ניהול רשימת הציוד הנדרש לאירועים</p>
                </div>
                <div class="p-4 sm:p-6">
                    <div class="mb-6">
                        <button onclick="showAddEquipmentForm()" class="bg-gradient-to-r from-gray-600 to-slate-600 text-white px-6 py-3 rounded-2xl hover:from-gray-700 hover:to-slate-700 transition-all shadow-lg flex items-center">
                            <span class="ml-2">➕</span>
                            <span class="font-medium">הוסף פריט ציוד</span>
                        </button>
                    </div>
                    <div class="space-y-4" id="equipmentContainer">
                        <!-- Equipment will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <div id="payments-page" class="page hidden">
            <div class="bg-white rounded-3xl shadow-lg border border-gray-100">
                <div class="bg-gradient-to-l from-green-50 to-emerald-50 border-b border-gray-200 p-4 sm:p-6 rounded-t-3xl">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-1">ניהול תשלומים והוצאות</h2>
                            <p class="text-gray-600 text-sm sm:text-base">מעקב אחר תשלומים לבעלי המקצוע והוצאות העסק</p>
                        </div>
                        <div class="flex bg-gray-100 rounded-xl p-1">
                            <button onclick="setPaymentsViewMode('payments')" id="paymentsViewPayments" class="px-4 py-2 rounded-lg text-sm font-medium transition-all bg-green-600 text-white">
                                💰 תשלומים
                            </button>
                            <button onclick="setPaymentsViewMode('expenses')" id="paymentsViewExpenses" class="px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:text-gray-800">
                                📊 הוצאות
                            </button>
                        </div>
                    </div>
                </div>
                <div class="p-4 sm:p-6">
                    <div id="paymentsContainer" class="space-y-4">
                        <!-- Payments will be loaded here -->
                    </div>
                    <div id="expensesContainer" class="space-y-4 hidden">
                        <!-- Expenses will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <div id="useful-links-page" class="page hidden">
            <div class="bg-white rounded-3xl shadow-lg border border-gray-100">
                <div class="bg-gradient-to-l from-indigo-50 to-purple-50 border-b border-gray-200 p-4 sm:p-6 rounded-t-3xl">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-1">קישורים שימושיים</h2>
                    <p class="text-gray-600 text-sm sm:text-base">קישורים חשובים לניהול העסק</p>
                </div>
                <div class="p-4 sm:p-6">
                    <div id="adminLinksButtons" class="mb-6 hidden">
                        <button onclick="showAddLinkForm()" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-3 rounded-2xl hover:from-indigo-700 hover:to-purple-700 transition-all shadow-lg flex items-center">
                            <span class="ml-2">➕</span>
                            <span class="font-medium">הוסף קישור</span>
                        </button>
                    </div>
                    <div class="space-y-4" id="usefulLinksContainer">
                        <!-- Useful links will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Basic data
        let blessings = [
            {
                id: 1,
                name: "ברכת הטלית",
                category: "ברכות התפילה",
                text: "ברוך אתה ה' אלוהינו מלך העולם אשר קדשנו במצוותיו וצונו להתעטף בציצית",
                notes: "נאמרת בעת עטיפת הטלית"
            },
            {
                id: 2,
                name: "ברכת התפילין",
                category: "ברכות התפילה",
                text: "ברוך אתה ה' אלוהינו מלך העולם אשר קדשנו במצוותיו וצונו להניח תפילין",
                notes: "נאמרת בעת הנחת התפילין"
            },
            {
                id: 3,
                name: "ברכת הגומל",
                category: "ברכות הודיה",
                text: "ברוך אתה ה' אלוהינו מלך העולם הגומל לחייבים טובות שגמלני כל טוב",
                notes: "נאמרת על ידי בעל השמחה אחרי קריאת התורה"
            },
            {
                id: 4,
                name: "שהחיינו",
                category: "ברכות זמן",
                text: "ברוך אתה ה' אלוהינו מלך העולם שהחיינו וקיימנו והגיענו לזמן הזה",
                notes: "ברכה על הגעה לרגע המיוחד"
            },
            {
                id: 5,
                name: "ברכת הכהנים",
                category: "ברכות מיוחדות",
                text: "יברכך ה' וישמרך\nיאר ה' פניו אליך ויחנך\nישא ה' פניו אליך וישם לך שלום",
                notes: "ברכה מיוחדת לבר המצווה"
            },
            {
                id: 6,
                name: "תפילת הדרך",
                category: "תפילות מיוחדות",
                text: "יהי רצון מלפניך ה' אלוהינו ואלוהי אבותינו שתוליכנו לשלום ותצעידנו לשלום ותגיענו למחוז חפצנו לחיים ולשמחה ולשלום",
                notes: "תפילה לדרך בטוחה"
            }
        ];

        let prayerSongs = [
            {
                id: 1,
                name: "שמע ישראל",
                key: "Am",
                tempo: 120,
                transpose: 0,
                chords: "Am - F - C - G",
                lyrics: "שמע ישראל ה' אלוהינו ה' אחד\nברוך שם כבוד מלכותו לעולם ועד",
                category: "תפילה"
            },
            {
                id: 2,
                name: "ברכו",
                key: "Dm",
                tempo: 90,
                transpose: 2,
                chords: "Dm - Bb - F - C",
                lyrics: "ברכו את ה' המבורך\nברוך ה' המבורך לעולם ועד",
                category: "כניסה"
            },
            {
                id: 3,
                name: "אדון עולם",
                key: "G",
                tempo: 100,
                transpose: -1,
                chords: "G - Em - C - D",
                lyrics: "אדון עולם אשר מלך\nבטרם כל יציר נברא",
                category: "תפילה"
            }
        ];

        let mealSongs = [
            {
                id: 1,
                name: "שלום עליכם",
                key: "C",
                tempo: 110,
                transpose: 0,
                chords: "C - Am - F - G",
                lyrics: "שלום עליכם מלאכי השרת\nמלאכי עליון\nממלך מלכי המלכים\nהקדוש ברוך הוא",
                category: "פתיחה"
            },
            {
                id: 2,
                name: "אשת חיל",
                key: "Em",
                tempo: 85,
                transpose: 1,
                chords: "Em - C - G - D",
                lyrics: "אשת חיל מי ימצא\nורחוק מפנינים מכרה\nבטח בה לב בעלה\nושלל לא יחסר",
                category: "כבוד האישה"
            },
            {
                id: 3,
                name: "ברכת המזון",
                key: "F",
                tempo: 95,
                transpose: -2,
                chords: "F - Dm - Bb - C",
                lyrics: "ברוך אתה ה' אלוהינו מלך העולם\nהזן את העולם כולו בטובו\nבחן בחסד וברחמים",
                category: "ברכה"
            },
            {
                id: 4,
                name: "הבדלה",
                key: "Am",
                tempo: 75,
                transpose: 0,
                chords: "Am - F - C - G",
                lyrics: "הנה אל ישועתי אבטח ולא אפחד\nכי עזי וזמרת יה ה'\nויהי לי לישועה",
                category: "סיום"
            }
        ];

        let events = [
            {
                id: 1,
                name: "דוד כהן",
                date: "2024-12-15",
                time: "10:00",
                guestArrivalTime: "09:30",
                eventStartTime: "10:00",
                location: "בית כנסת הגדול, תל אביב",
                wazeLink: "https://waze.com/ul?q=בית כנסת הגדול תל אביב",
                package: "חבילה חגיגית",
                keyboardist: true,
                drummers: 1,
                isStudent: true,
                price: 3500,
                parentPhone: "050-1234567",
                parentName: "משה כהן",
                notes: "נער מוכשר, מעדיף שירים מזרחיים",
                photosLink: "https://drive.google.com/drive/folders/1234567890",
                videosLink: "https://drive.google.com/drive/folders/0987654321"
            },
            {
                id: 2,
                name: "יוסי לוי",
                date: "2024-01-20",
                time: "11:00",
                guestArrivalTime: "10:30",
                eventStartTime: "11:00",
                location: "בית כנסת אור החיים, ירושלים",
                wazeLink: "https://waze.com/ul?q=בית כנסת אור החיים ירושלים",
                package: "חבילה בסיסית",
                keyboardist: false,
                drummers: 0,
                isStudent: false,
                price: 2000,
                parentPhone: "052-9876543",
                parentName: "אברהם לוי",
                notes: "משפחה מסורתית, שירים קלאסיים",
                photosLink: "",
                videosLink: ""
            },
            {
                id: 3,
                name: "אליהו מזרחי",
                date: "2025-01-10",
                time: "09:00",
                guestArrivalTime: "08:30",
                eventStartTime: "09:00",
                location: "בית כנסת שערי צדק, חיפה",
                wazeLink: "https://waze.com/ul?q=בית כנסת שערי צדק חיפה",
                package: "חבילה מורחבת",
                keyboardist: true,
                drummers: 2,
                isStudent: true,
                price: 4200,
                parentPhone: "054-5555555",
                parentName: "יעקב מזרחי",
                notes: "אירוע גדול, 200 אורחים",
                photosLink: "",
                videosLink: ""
            },
            {
                id: 4,
                name: "נתן גולד",
                date: "2024-11-05",
                time: "10:30",
                guestArrivalTime: "10:00",
                eventStartTime: "10:30",
                location: "בית כנסת בית יעקב, בני ברק",
                wazeLink: "https://waze.com/ul?q=בית כנסת בית יעקב בני ברק",
                package: "חבילה בסיסית",
                keyboardist: false,
                drummers: 1,
                isStudent: false,
                price: 2500,
                parentPhone: "053-7777777",
                parentName: "שמואל גולד",
                notes: "אירוע קטן ואינטימי",
                photosLink: "https://drive.google.com/drive/folders/sample123",
                videosLink: ""
            },
            {
                id: 5,
                name: "רון אבני",
                date: "2025-03-18",
                time: "11:30",
                guestArrivalTime: "11:00",
                eventStartTime: "11:30",
                location: "בית כנסת מגן אברהם, רמת גן",
                wazeLink: "https://waze.com/ul?q=בית כנסת מגן אברהם רמת גן",
                package: "חבילה חגיגית",
                keyboardist: true,
                drummers: 0,
                isStudent: true,
                price: 3200,
                parentPhone: "052-8888888",
                parentName: "דני אבני",
                notes: "תלמיד מתקדם, יודע לנגן גיטרה",
                photosLink: "",
                videosLink: ""
            }
        ];

        let equipment = [
            { id: 1, name: "מיקרופון אלחוטי" },
            { id: 2, name: "רמקולים" },
            { id: 3, name: "מערכת הגברה" },
            { id: 4, name: "כבלי חשמל" },
            { id: 5, name: "מעמד מיקרופון" },
            { id: 6, name: "קלידים" },
            { id: 7, name: "תופים" },
            { id: 8, name: "כבלי אודיו" },
            { id: 9, name: "מיקסר" },
            { id: 10, name: "אוזניות מוניטור" }
        ];

        // Payments data - linked to events by eventId
        let payments = [
            {
                id: 1,
                eventId: 1, // דוד כהן
                keyboardistPaid: true,
                keyboardistDate: "2024-11-20",
                keyboardistMethod: "העברה בנקאית",
                drummersPaid: false,
                drummersDate: "",
                drummersMethod: "",
                managerPaid: true,
                managerDate: "2024-11-18",
                managerMethod: "מזומן"
            },
            {
                id: 2,
                eventId: 3, // אליהו מזרחי
                keyboardistPaid: false,
                keyboardistDate: "",
                keyboardistMethod: "",
                drummersPaid: false,
                drummersDate: "",
                drummersMethod: "",
                managerPaid: false,
                managerDate: "",
                managerMethod: ""
            }
        ];

        // Expenses data
        let expenses = [
            {
                id: 1,
                date: "2024-11-15",
                category: "נסיעות",
                description: "דלק לאירוע דוד כהן",
                amount: 120,
                eventId: 1
            },
            {
                id: 2,
                date: "2024-11-10",
                category: "ציוד",
                description: "כבל מיקרופון חדש",
                amount: 85,
                eventId: null
            },
            {
                id: 3,
                date: "2024-11-08",
                category: "פרסום",
                description: "פרסום בפייסבוק",
                amount: 200,
                eventId: null
            }
        ];

        // Useful Links data
        let usefulLinks = [
            {
                id: 1,
                name: "הנפקת חשבוניות",
                url: "https://green.co.il",
                description: "מערכת הנפקת חשבוניות ירוק",
                category: "כספים",
                icon: "💰"
            },
            {
                id: 2,
                name: "גוגל דרייב - תמונות",
                url: "https://drive.google.com/drive/folders/photos",
                description: "תיקיית התמונות הראשית",
                category: "אחסון",
                icon: "📸"
            },
            {
                id: 3,
                name: "גוגל דרייב - סרטונים",
                url: "https://drive.google.com/drive/folders/videos",
                description: "תיקיית הסרטונים הראשית",
                category: "אחסון",
                icon: "🎥"
            },
            {
                id: 4,
                name: "יומן גוגל",
                url: "https://calendar.google.com",
                description: "יומן האירועים",
                category: "ניהול זמן",
                icon: "📅"
            },
            {
                id: 5,
                name: "WhatsApp Business",
                url: "https://business.whatsapp.com",
                description: "ניהול הודעות עסקיות",
                category: "תקשורת",
                icon: "💬"
            }
        ];

        // State
        let isLoggedIn = false;
        let currentPage = 'events';
        let editingPrayerSong = null;
        let editingMealSong = null;
        let editingEvent = null;
        let editingBlessing = null;
        let editingEquipment = null;
        let currentEventFilter = 'all';
        let filtersVisible = false;
        let prayerViewMode = 'list';
        let mealViewMode = 'list';
        let paymentsViewMode = 'payments';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initAuth0();
            renderCurrentPage();
        });

        // Navigation functions
        function openSidebar() {
            document.getElementById('sidebar').classList.add('open');
            document.getElementById('overlay').classList.remove('hidden');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('open');
            document.getElementById('overlay').classList.add('hidden');
        }

        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(page + '-page').classList.remove('hidden');
            currentPage = page;
            renderCurrentPage();
            closeSidebar();
        }

        // Auth0 Configuration
        const auth0Config = {
            domain: 'your-domain.auth0.com',
            clientId: 'your-client-id',
            redirectUri: window.location.origin
        };

        let auth0Client = null;
        let currentUser = null;

        // Initialize Auth0
        async function initAuth0() {
            try {
                auth0Client = await auth0.createAuth0Client({
                    domain: auth0Config.domain,
                    clientId: auth0Config.clientId,
                    authorizationParams: {
                        redirect_uri: auth0Config.redirectUri
                    }
                });

                // Check if user is already authenticated
                const isAuthenticated = await auth0Client.isAuthenticated();
                if (isAuthenticated) {
                    currentUser = await auth0Client.getUser();
                    updateUIForLoggedInUser();
                }

                // Handle redirect callback
                const query = window.location.search;
                if (query.includes('code=') && query.includes('state=')) {
                    await auth0Client.handleRedirectCallback();
                    currentUser = await auth0Client.getUser();
                    updateUIForLoggedInUser();
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            } catch (error) {
                console.error('Auth0 initialization error:', error);
                // Fallback to demo mode
                showDemoLoginModal();
            }
        }

        // Auth functions
        async function login() {
            if (auth0Client) {
                try {
                    await auth0Client.loginWithPopup({
                        authorizationParams: {
                            prompt: 'login'
                        }
                    });
                    currentUser = await auth0Client.getUser();
                    updateUIForLoggedInUser();
                } catch (error) {
                    console.error('Login error:', error);
                    if (error.error === 'popup_blocked' || error.error === 'popup_closed_by_user') {
                        // Fallback to redirect
                        await auth0Client.loginWithRedirect();
                    } else {
                        showDemoLoginModal();
                    }
                }
            } else {
                showDemoLoginModal();
            }
        }

        function showDemoLoginModal() {
            const modalHtml = `
                <div id="demoLoginModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-2xl max-w-md w-full">
                        <div class="bg-gradient-to-l from-blue-600 to-indigo-600 text-white p-6 rounded-t-3xl text-center">
                            <div class="text-4xl mb-3">🔐</div>
                            <h3 class="text-xl font-bold mb-2">התחברות למערכת</h3>
                            <p class="text-blue-100 text-sm">גרסת הדגמה - Auth0</p>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <div class="text-center mb-6">
                                <p class="text-gray-600 text-sm mb-4">בחר את ספק ההתחברות המועדף עליך:</p>
                            </div>
                            
                            <button onclick="loginWithProvider('Google')" class="w-full bg-white border-2 border-gray-300 text-gray-700 px-6 py-3 rounded-xl hover:border-gray-400 hover:shadow-md transition-all flex items-center justify-center font-medium">
                                <div class="w-5 h-5 ml-3 bg-red-500 rounded-full flex items-center justify-center text-white text-xs font-bold">G</div>
                                <span>המשך עם Google</span>
                            </button>
                            
                            <button onclick="loginWithProvider('Microsoft')" class="w-full bg-white border-2 border-gray-300 text-gray-700 px-6 py-3 rounded-xl hover:border-gray-400 hover:shadow-md transition-all flex items-center justify-center font-medium">
                                <div class="w-5 h-5 ml-3 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs font-bold">M</div>
                                <span>המשך עם Microsoft</span>
                            </button>
                            
                            <div class="relative my-6">
                                <div class="absolute inset-0 flex items-center">
                                    <div class="w-full border-t border-gray-300"></div>
                                </div>
                                <div class="relative flex justify-center text-sm">
                                    <span class="px-2 bg-white text-gray-500">או</span>
                                </div>
                            </div>
                            
                            <button onclick="loginWithProvider('Demo')" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-3 rounded-xl hover:from-purple-700 hover:to-indigo-700 transition-all flex items-center justify-center font-medium shadow-lg">
                                <span class="ml-2">🎭</span>
                                <span>כניסה לגרסת הדגמה</span>
                            </button>
                            
                            <button onclick="closeDemoLoginModal()" class="w-full mt-4 text-gray-500 hover:text-gray-700 transition-colors text-sm">
                                ביטול
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeDemoLoginModal() {
            const modal = document.getElementById('demoLoginModal');
            if (modal) modal.remove();
        }

        function loginWithProvider(provider) {
            currentUser = {
                name: 'מנהל המערכת',
                email: 'admin@example.com',
                picture: '',
                sub: 'demo-user-123',
                provider: provider
            };
            
            closeDemoLoginModal();
            updateUIForLoggedInUser();
        }

        function updateUIForLoggedInUser() {
            isLoggedIn = true;
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('adminSection').classList.remove('hidden');
            document.getElementById('adminPrayerButtons').classList.remove('hidden');
            document.getElementById('adminMealButtons').classList.remove('hidden');
            document.getElementById('adminBlessingsButtons').classList.remove('hidden');
            document.getElementById('adminLinksButtons').classList.remove('hidden');
            
            // Update user info display
            if (currentUser) {
                const userInfoHtml = `
                    <div class="bg-green-50 p-4 rounded-2xl border border-green-200">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                ${currentUser.picture ? `
                                    <img src="${currentUser.picture}" alt="תמונת פרופיל" class="w-10 h-10 rounded-full ml-3 border-2 border-green-300">
                                ` : `
                                    <div class="w-10 h-10 rounded-full ml-3 bg-green-500 flex items-center justify-center text-white font-bold">
                                        ${currentUser.name ? currentUser.name.charAt(0) : 'M'}
                                    </div>
                                `}
                                <div>
                                    <div class="text-green-800 font-medium">${currentUser.name || 'מנהל המערכת'}</div>
                                    <div class="text-green-600 text-xs">${currentUser.email || 'admin@example.com'}</div>
                                    ${currentUser.provider ? `<div class="text-green-500 text-xs">דרך ${currentUser.provider}</div>` : ''}
                                </div>
                            </div>
                            <span class="text-green-500 text-xl">✅</span>
                        </div>
                        <button onclick="logout()" class="w-full bg-red-600 text-white px-4 py-2 rounded-2xl text-sm hover:bg-red-700 transition-colors">
                            יציאה
                        </button>
                    </div>
                `;
                document.getElementById('userInfo').innerHTML = userInfoHtml;
            }
            
            renderCurrentPage();
        }

        async function logout() {
            if (auth0Client && currentUser && currentUser.provider !== 'Demo') {
                try {
                    await auth0Client.logout({
                        logoutParams: {
                            returnTo: window.location.origin
                        }
                    });
                } catch (error) {
                    console.error('Logout error:', error);
                }
            }
            
            // Clear user data
            currentUser = null;
            isLoggedIn = false;
            
            // Update UI
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('adminSection').classList.add('hidden');
            document.getElementById('adminPrayerButtons').classList.add('hidden');
            document.getElementById('adminMealButtons').classList.add('hidden');
            document.getElementById('adminBlessingsButtons').classList.add('hidden');
            document.getElementById('adminLinksButtons').classList.add('hidden');
            renderCurrentPage();
        }

        // Filter functions
        function toggleFilters() {
            const filtersSection = document.getElementById('filtersSection');
            const filterArrow = document.getElementById('filterArrow');
            
            if (filtersVisible) {
                filtersSection.classList.add('hidden');
                filterArrow.style.transform = 'rotate(0deg)';
                filtersVisible = false;
            } else {
                filtersSection.classList.remove('hidden');
                filterArrow.style.transform = 'rotate(180deg)';
                filtersVisible = true;
            }
        }

        function setEventFilter(filter) {
            currentEventFilter = filter;
            
            // Update active button
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`filter-${filter}`).classList.add('active');
            
            // Update status text
            const statusTexts = {
                'all': 'כל האירועים',
                'future': 'אירועים עתידיים',
                'past': 'אירועים שהסתיימו',
                'keyboardist': 'אירועים עם קלידן',
                'drummers': 'אירועים עם מתופפים',
                'students': 'אירועי תלמידים'
            };
            document.getElementById('filterStatus').textContent = `מציג: ${statusTexts[filter]}`;
            
            renderEvents();
        }

        function filterEvents(events) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            return events.filter(event => {
                const eventDate = new Date(event.date);
                eventDate.setHours(0, 0, 0, 0);
                
                switch(currentEventFilter) {
                    case 'future':
                        return eventDate >= today;
                    case 'past':
                        return eventDate < today;
                    case 'keyboardist':
                        return event.keyboardist;
                    case 'drummers':
                        return event.drummers > 0;
                    case 'students':
                        return event.isStudent;
                    default:
                        return true;
                }
            });
        }

        // Render functions
        function renderCurrentPage() {
            switch(currentPage) {
                case 'events':
                    renderEvents();
                    break;
                case 'prayer-songs':
                    renderPrayerSongs();
                    break;
                case 'meal-songs':
                    renderMealSongs();
                    break;
                case 'blessings':
                    renderBlessings();
                    break;
                case 'admin':
                    if (isLoggedIn) renderStudents();
                    break;
                case 'equipment':
                    if (isLoggedIn) renderEquipment();
                    break;
                case 'payments':
                    if (isLoggedIn) renderPaymentsPage();
                    break;
                case 'useful-links':
                    if (isLoggedIn) renderUsefulLinks();
                    break;
            }
        }

        function renderEvents() {
            const container = document.getElementById('eventsContainer');
            const filteredEvents = filterEvents(events);
            
            // Set active filter button on initial load
            if (document.getElementById(`filter-${currentEventFilter}`)) {
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                document.getElementById(`filter-${currentEventFilter}`).classList.add('active');
            }
            
            if (filteredEvents.length === 0) {
                const filterMessages = {
                    'all': 'לא נמצאו אירועים במערכת',
                    'future': 'לא נמצאו אירועים עתידיים',
                    'past': 'לא נמצאו אירועים שהסתיימו',
                    'keyboardist': 'לא נמצאו אירועים עם קלידן',
                    'drummers': 'לא נמצאו אירועים עם מתופפים',
                    'students': 'לא נמצאו אירועי תלמידים'
                };
                
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">📅</div>
                        <h3 class="text-xl font-bold text-gray-600 mb-2">${filterMessages[currentEventFilter]}</h3>
                        <p class="text-gray-500">נסה לשנות את הסינון או להוסיף אירועים חדשים</p>
                        ${isLoggedIn ? `
                        <button onclick="showAddEventForm()" class="mt-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-3 rounded-2xl hover:from-blue-700 hover:to-indigo-700 transition-all shadow-lg flex items-center mx-auto">
                            <span class="ml-2">➕</span>
                            <span class="font-medium">הוסף אירוע חדש</span>
                        </button>
                        ` : ''}
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                ${isLoggedIn ? `
                <div class="mb-6">
                    <button onclick="showAddEventForm()" class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-3 rounded-2xl hover:from-blue-700 hover:to-indigo-700 transition-all shadow-lg flex items-center">
                        <span class="ml-2">➕</span>
                        <span class="font-medium">הוסף אירוע חדש</span>
                    </button>
                </div>
                ` : ''}
                
                <div class="space-y-4">
                    ${filteredEvents.map((event, index) => {
                        const eventDate = new Date(event.date);
                        const formattedDate = eventDate.toLocaleDateString('he-IL', {
                            day: 'numeric',
                            month: 'long',
                            year: 'numeric'
                        });
                        const dayName = eventDate.toLocaleDateString('he-IL', { weekday: 'long' });

                        const gradientClass = `card-gradient-${(index % 6) + 1}`;
                        
                        return `
                            <div class="card-professional bg-white rounded-xl shadow-md hover:shadow-lg transition-all duration-300 overflow-hidden">
                                <div class="${gradientClass} p-4 text-white cursor-pointer" onclick="toggleEventDetails('event-${event.id}')">
                                    <div class="flex justify-between items-center">
                                        <div class="flex items-center">
                                            <h3 class="text-xl font-bold">בר מצווה - ${event.name}</h3>
                                        </div>
                                        <div class="flex items-center space-x-2 space-x-reverse">
                                            ${event.isStudent ? '<span class="bg-white bg-opacity-20 text-white px-2 py-1 rounded-full text-xs font-medium">תלמיד</span>' : ''}
                                            ${isLoggedIn ? `
                                            <button onclick="event.stopPropagation(); editEvent(${event.id})" class="bg-white bg-opacity-20 text-white px-3 py-1 rounded-lg text-sm hover:bg-opacity-30 transition-colors">
                                                ✏️ עריכה
                                            </button>
                                            ` : ''}
                                            <span id="event-arrow-${event.id}" class="text-white text-xl transition-transform duration-300">▼</span>
                                        </div>
                                    </div>
                                </div>

                                <div id="event-details-${event.id}" class="hidden p-4">
                                    <!-- Enhanced Event Info -->
                                    <div class="grid grid-cols-1 gap-4 mb-4">
                                        <!-- Date Section -->
                                        <div class="bg-gradient-to-br from-emerald-500 via-teal-500 to-cyan-600 text-white p-4 rounded-2xl shadow-lg border-2 border-emerald-300">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center">
                                                    <div class="bg-white bg-opacity-20 p-2 rounded-full ml-3">
                                                        <span class="text-2xl">📅</span>
                                                    </div>
                                                    <div>
                                                        <div class="text-xl font-bold">${formattedDate}</div>
                                                        <div class="text-emerald-100 text-sm font-medium">${dayName}</div>
                                                    </div>
                                                </div>
                                                <div class="bg-white bg-opacity-20 p-2 rounded-full cursor-pointer hover:bg-opacity-30 transition-all" onclick="addEventToGoogleCalendar(${event.id})">
                                                    <span class="text-xl">📅</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Location Section -->
                                        <div class="bg-gradient-to-br from-orange-500 via-red-500 to-pink-600 text-white p-4 rounded-2xl shadow-lg border-2 border-orange-300">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center">
                                                    <div class="bg-white bg-opacity-20 p-2 rounded-full ml-3">
                                                        <span class="text-2xl">📍</span>
                                                    </div>
                                                    <div>
                                                        <div class="text-lg font-bold">${event.location}</div>
                                                        <div class="text-orange-100 text-sm font-medium">לחץ לפתיחה ב-Waze</div>
                                                    </div>
                                                </div>
                                                <div class="bg-white bg-opacity-20 p-2 rounded-full cursor-pointer hover:bg-opacity-30 transition-all" onclick="openWaze('${event.wazeLink}')">
                                                    <span class="text-xl">🗺️</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    

                                    
                                    <div class="border-t border-gray-200 pt-4 flex justify-end">
                                        <button onclick="showEventDetails(${event.id})" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-3 py-2 rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all flex items-center shadow-md text-sm">
                                            <span class="font-medium">פרטים נוספים</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function setPrayerViewMode(mode) {
            prayerViewMode = mode;
            
            // Update button styles
            document.getElementById('prayerViewList').className = mode === 'list' 
                ? 'px-4 py-2 rounded-lg text-sm font-medium transition-all bg-purple-600 text-white'
                : 'px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:text-gray-800';
            
            document.getElementById('prayerViewCategories').className = mode === 'categories'
                ? 'px-4 py-2 rounded-lg text-sm font-medium transition-all bg-purple-600 text-white'
                : 'px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:text-gray-800';
            
            renderPrayerSongs();
        }

        function setMealViewMode(mode) {
            mealViewMode = mode;
            
            // Update button styles
            document.getElementById('mealViewList').className = mode === 'list' 
                ? 'px-4 py-2 rounded-lg text-sm font-medium transition-all bg-green-600 text-white'
                : 'px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:text-gray-800';
            
            document.getElementById('mealViewCategories').className = mode === 'categories'
                ? 'px-4 py-2 rounded-lg text-sm font-medium transition-all bg-green-600 text-white'
                : 'px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:text-gray-800';
            
            renderMealSongs();
        }

        function renderPrayerSongs() {
            const container = document.getElementById('prayerSongsContainer');
            
            if (prayerSongs.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">🎵</div>
                        <h3 class="text-xl font-bold text-gray-600 mb-2">לא נמצאו שירים</h3>
                        <p class="text-gray-500">השתמש בכפתור "הוסף שיר" כדי להוסיף שירי תפילה</p>
                    </div>
                `;
                return;
            }

            if (prayerViewMode === 'categories') {
                renderPrayerSongsByCategories(container);
            } else {
                renderPrayerSongsList(container);
            }
        }

        function renderPrayerSongsList(container) {
            container.innerHTML = prayerSongs.map((song, index) => {
                const gradientClass = `card-gradient-${(index % 6) + 1}`;
                const uniqueId = `prayer-${song.id}`;
                return `
                    <div class="bg-white border border-gray-200 rounded-3xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden">
                        <div class="${gradientClass} p-4 text-white cursor-pointer" onclick="toggleSongDetails('${uniqueId}')">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <span class="text-2xl ml-3">🎵</span>
                                    <h3 class="text-lg font-bold">${song.name}</h3>
                                </div>
                                <div class="flex items-center space-x-2 space-x-reverse">
                                    <span class="bg-white bg-opacity-20 text-white px-3 py-1 rounded-full text-xs font-medium">${song.category}</span>
                                    ${isLoggedIn ? `
                                    <button onclick="event.stopPropagation(); editPrayerSong(${song.id})" class="bg-white bg-opacity-20 text-white px-3 py-1 rounded-lg text-sm hover:bg-opacity-30 transition-colors">
                                        ✏️ עריכה
                                    </button>
                                    <button onclick="event.stopPropagation(); deletePrayerSong(${song.id})" class="bg-red-500 bg-opacity-80 text-white px-3 py-1 rounded-lg text-sm hover:bg-opacity-100 transition-colors">
                                        🗑️ מחק
                                    </button>
                                    ` : ''}
                                    <span id="arrow-${uniqueId}" class="text-white text-xl transition-transform duration-300">▼</span>
                                </div>
                            </div>
                        </div>

                        <div id="song-details-${uniqueId}" class="hidden p-4">
                            <div class="flex flex-wrap gap-2 mb-4">
                                <span class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-4 py-2 rounded-2xl text-sm font-bold shadow-md">
                                    🎵 ${song.key}
                                </span>
                                <span class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-4 py-2 rounded-2xl text-sm font-bold shadow-md">
                                    ⏱️ ${song.tempo}
                                </span>
                                <span class="bg-gradient-to-r from-purple-500 to-pink-600 text-white px-4 py-2 rounded-2xl text-sm font-bold shadow-md">
                                    🎹 ${song.transpose > 0 ? '+' : ''}${song.transpose}
                                </span>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-2xl mb-3 border border-gray-200">
                                <div class="text-sm font-bold text-gray-700 mb-2">🎸 אקורדים</div>
                                <div class="text-sm text-gray-600 font-mono bg-white p-3 rounded-xl border whitespace-pre-line">${song.chords}</div>
                            </div>
                            
                            <div class="bg-blue-50 p-4 rounded-2xl border border-blue-200">
                                <div class="text-sm font-bold text-blue-700 mb-2">📝 מילים</div>
                                <div class="text-sm text-blue-600 whitespace-pre-line bg-white p-3 rounded-xl border border-blue-200">${song.lyrics}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderPrayerSongsByCategories(container) {
            // Group songs by category
            const categories = {};
            prayerSongs.forEach(song => {
                if (!categories[song.category]) {
                    categories[song.category] = [];
                }
                categories[song.category].push(song);
            });

            let html = '';
            Object.keys(categories).forEach((category, categoryIndex) => {
                const categoryGradient = `card-gradient-${(categoryIndex % 6) + 1}`;
                const categoryId = `prayer-category-${categoryIndex}`;
                html += `
                    <div class="mb-6">
                        <div class="${categoryGradient} p-4 rounded-2xl text-white mb-4 cursor-pointer" onclick="toggleCategoryDetails('${categoryId}')">
                            <h3 class="text-xl font-bold flex items-center">
                                ${category}
                                <span class="mr-auto bg-white bg-opacity-20 text-white px-3 py-1 rounded-full text-sm font-medium">${categories[category].length} שירים</span>
                                <span id="category-arrow-${categoryId}" class="text-white text-xl transition-transform duration-300">▼</span>
                            </h3>
                        </div>
                        <div id="category-content-${categoryId}" class="hidden space-y-4 mr-4">
                            ${categories[category].map((song, index) => {
                                const uniqueId = `prayer-${song.id}`;
                                return `
                                    <div class="bg-white border border-gray-200 rounded-2xl shadow-md hover:shadow-lg transition-all duration-300 overflow-hidden">
                                        <div class="${categoryGradient} p-3 cursor-pointer text-white" onclick="toggleSongDetails('${uniqueId}')">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center">
                                                    <span class="text-lg ml-2">🎵</span>
                                                    <h4 class="font-bold text-white">${song.name}</h4>
                                                </div>
                                                <div class="flex items-center space-x-2 space-x-reverse">
                                                    ${isLoggedIn ? `
                                                    <button onclick="event.stopPropagation(); editPrayerSong(${song.id})" class="bg-white bg-opacity-20 text-white px-2 py-1 rounded text-xs hover:bg-opacity-30 transition-colors">
                                                        ✏️ עריכה
                                                    </button>
                                                    <button onclick="event.stopPropagation(); deletePrayerSong(${song.id})" class="bg-red-500 bg-opacity-80 text-white px-2 py-1 rounded text-xs hover:bg-opacity-100 transition-colors">
                                                        🗑️ מחק
                                                    </button>
                                                    ` : ''}
                                                    <span id="arrow-${uniqueId}" class="text-white text-lg transition-transform duration-300">▼</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div id="song-details-${uniqueId}" class="hidden p-4">
                                            <div class="flex flex-wrap gap-2 mb-4">
                                                <span class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-3 py-1 rounded-xl text-xs font-bold shadow-sm">
                                                    🎵 ${song.key}
                                                </span>
                                                <span class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-3 py-1 rounded-xl text-xs font-bold shadow-sm">
                                                    ⏱️ ${song.tempo}
                                                </span>
                                                <span class="bg-gradient-to-r from-purple-500 to-pink-600 text-white px-3 py-1 rounded-xl text-xs font-bold shadow-sm">
                                                    🎹 ${song.transpose > 0 ? '+' : ''}${song.transpose}
                                                </span>
                                            </div>
                                            
                                            <div class="bg-gray-50 p-3 rounded-xl mb-3 border border-gray-200">
                                                <div class="text-xs font-bold text-gray-700 mb-2">🎸 אקורדים</div>
                                                <div class="text-xs text-gray-600 font-mono bg-white p-2 rounded border whitespace-pre-line">${song.chords}</div>
                                            </div>
                                            
                                            <div class="bg-blue-50 p-3 rounded-xl border border-blue-200">
                                                <div class="text-xs font-bold text-blue-700 mb-2">📝 מילים</div>
                                                <div class="text-xs text-blue-600 whitespace-pre-line bg-white p-2 rounded border border-blue-200">${song.lyrics}</div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderMealSongs() {
            const container = document.getElementById('mealSongsContainer');
            
            if (mealSongs.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">🍽️</div>
                        <h3 class="text-xl font-bold text-gray-600 mb-2">לא נמצאו שירים</h3>
                        <p class="text-gray-500">השתמש בכפתור "הוסף שיר" כדי להוסיף שירי סעודה</p>
                    </div>
                `;
                return;
            }

            if (mealViewMode === 'categories') {
                renderMealSongsByCategories(container);
            } else {
                renderMealSongsList(container);
            }
        }

        function renderMealSongsList(container) {
            container.innerHTML = mealSongs.map((song, index) => {
                const gradientClass = `card-gradient-${(index % 6) + 1}`;
                const uniqueId = `meal-${song.id}`;
                
                return `
                    <div class="bg-white border border-gray-200 rounded-3xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden">
                        <div class="${gradientClass} p-4 text-white cursor-pointer" onclick="toggleSongDetails('${uniqueId}')">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <span class="text-2xl ml-3">🍽️</span>
                                    <h3 class="text-lg font-bold">${song.name}</h3>
                                </div>
                                <div class="flex items-center space-x-2 space-x-reverse">
                                    <span class="bg-white bg-opacity-20 text-white px-3 py-1 rounded-full text-xs font-medium">${song.category}</span>
                                    ${isLoggedIn ? `
                                    <button onclick="event.stopPropagation(); editMealSong(${song.id})" class="bg-white bg-opacity-20 text-white px-3 py-1 rounded-lg text-sm hover:bg-opacity-30 transition-colors">
                                        ✏️ עריכה
                                    </button>
                                    <button onclick="event.stopPropagation(); deleteMealSong(${song.id})" class="bg-red-500 bg-opacity-80 text-white px-3 py-1 rounded-lg text-sm hover:bg-opacity-100 transition-colors">
                                        🗑️ מחק
                                    </button>
                                    ` : ''}
                                    <span id="arrow-${uniqueId}" class="text-white text-xl transition-transform duration-300">▼</span>
                                </div>
                            </div>
                        </div>

                        <div id="song-details-${uniqueId}" class="hidden p-4">
                            <div class="flex flex-wrap gap-2 mb-4">
                                <span class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-4 py-2 rounded-2xl text-sm font-bold shadow-md">
                                    🎵 ${song.key}
                                </span>
                                <span class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-4 py-2 rounded-2xl text-sm font-bold shadow-md">
                                    ⏱️ ${song.tempo}
                                </span>
                                <span class="bg-gradient-to-r from-purple-500 to-pink-600 text-white px-4 py-2 rounded-2xl text-sm font-bold shadow-md">
                                    🎹 ${song.transpose > 0 ? '+' : ''}${song.transpose}
                                </span>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-2xl mb-3 border border-gray-200">
                                <div class="text-sm font-bold text-gray-700 mb-2">🎸 אקורדים</div>
                                <div class="text-sm text-gray-600 font-mono bg-white p-3 rounded-xl border whitespace-pre-line">${song.chords}</div>
                            </div>
                            
                            <div class="bg-green-50 p-4 rounded-2xl border border-green-200">
                                <div class="text-sm font-bold text-green-700 mb-2">📝 מילים</div>
                                <div class="text-sm text-green-600 whitespace-pre-line bg-white p-3 rounded-xl border border-green-200">${song.lyrics}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderMealSongsByCategories(container) {
            // Group songs by category
            const categories = {};
            mealSongs.forEach(song => {
                if (!categories[song.category]) {
                    categories[song.category] = [];
                }
                categories[song.category].push(song);
            });

            let html = '';
            Object.keys(categories).forEach((category, categoryIndex) => {
                const categoryGradient = `card-gradient-${(categoryIndex % 6) + 1}`;
                const categoryId = `meal-category-${categoryIndex}`;
                html += `
                    <div class="mb-6">
                        <div class="${categoryGradient} p-4 rounded-2xl text-white mb-4 cursor-pointer" onclick="toggleCategoryDetails('${categoryId}')">
                            <h3 class="text-xl font-bold flex items-center">
                                ${category}
                                <span class="mr-auto bg-white bg-opacity-20 text-white px-3 py-1 rounded-full text-sm font-medium">${categories[category].length} שירים</span>
                                <span id="category-arrow-${categoryId}" class="text-white text-xl transition-transform duration-300">▼</span>
                            </h3>
                        </div>
                        <div id="category-content-${categoryId}" class="hidden space-y-4 mr-4">
                            ${categories[category].map((song, index) => {
                                const uniqueId = `meal-${song.id}`;
                                
                                return `
                                    <div class="bg-white border border-gray-200 rounded-2xl shadow-md hover:shadow-lg transition-all duration-300 overflow-hidden">
                                        <div class="${categoryGradient} bg-opacity-20 p-3 cursor-pointer" onclick="toggleSongDetails('${uniqueId}')">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center">
                                                    <span class="text-lg ml-2">🍽️</span>
                                                    <h4 class="font-bold text-gray-800">${song.name}</h4>
                                                </div>
                                                <div class="flex items-center space-x-2 space-x-reverse">
                                                    ${isLoggedIn ? `
                                                    <button onclick="event.stopPropagation(); editMealSong(${song.id})" class="bg-green-600 text-white px-2 py-1 rounded text-xs hover:bg-green-700 transition-colors">
                                                        ✏️ עריכה
                                                    </button>
                                                    <button onclick="event.stopPropagation(); deleteMealSong(${song.id})" class="bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700 transition-colors">
                                                        🗑️ מחק
                                                    </button>
                                                    ` : ''}
                                                    <span id="arrow-${uniqueId}" class="text-gray-600 text-lg transition-transform duration-300">▼</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div id="song-details-${uniqueId}" class="hidden p-4">
                                            <div class="flex flex-wrap gap-2 mb-4">
                                                <span class="bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-3 py-1 rounded-xl text-xs font-bold shadow-sm">
                                                    🎵 ${song.key}
                                                </span>
                                                <span class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-3 py-1 rounded-xl text-xs font-bold shadow-sm">
                                                    ⏱️ ${song.tempo}
                                                </span>
                                                <span class="bg-gradient-to-r from-purple-500 to-pink-600 text-white px-3 py-1 rounded-xl text-xs font-bold shadow-sm">
                                                    🎹 ${song.transpose > 0 ? '+' : ''}${song.transpose}
                                                </span>
                                            </div>
                                            
                                            <div class="bg-gray-50 p-3 rounded-xl mb-3 border border-gray-200">
                                                <div class="text-xs font-bold text-gray-700 mb-2">🎸 אקורדים</div>
                                                <div class="text-xs text-gray-600 font-mono bg-white p-2 rounded border whitespace-pre-line">${song.chords}</div>
                                            </div>
                                            
                                            <div class="bg-green-50 p-3 rounded-xl border border-green-200">
                                                <div class="text-xs font-bold text-green-700 mb-2">📝 מילים</div>
                                                <div class="text-xs text-green-600 whitespace-pre-line bg-white p-2 rounded border border-green-200">${song.lyrics}</div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderBlessings() {
            const container = document.getElementById('blessingsContainer');
            
            if (blessings.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">🙏</div>
                        <h3 class="text-xl font-bold text-gray-600 mb-2">לא נמצאו ברכות ותפילות</h3>
                        <p class="text-gray-500">השתמש בכפתור "הוסף ברכה/תפילה" כדי להתחיל</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = blessings.map((blessing, index) => {
                const gradientClass = `card-gradient-${(index % 6) + 1}`;
                const uniqueId = `blessing-${blessing.id}`;
                
                return `
                    <div class="bg-white border border-gray-200 rounded-3xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden">
                        <div class="${gradientClass} p-4 text-white cursor-pointer" onclick="toggleBlessingDetails('${uniqueId}')">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <span class="text-2xl ml-3">🙏</span>
                                    <h3 class="text-lg font-bold">${blessing.name}</h3>
                                </div>
                                <div class="flex items-center space-x-2 space-x-reverse">
                                    <span class="bg-white bg-opacity-20 text-white px-3 py-1 rounded-full text-xs font-medium">${blessing.category}</span>
                                    ${isLoggedIn ? `
                                    <button onclick="event.stopPropagation(); editBlessing(${blessing.id})" class="bg-white bg-opacity-20 text-white px-3 py-1 rounded-lg text-sm hover:bg-opacity-30 transition-colors">
                                        ✏️ עריכה
                                    </button>
                                    <button onclick="event.stopPropagation(); deleteBlessing(${blessing.id})" class="bg-red-500 bg-opacity-80 text-white px-3 py-1 rounded-lg text-sm hover:bg-opacity-100 transition-colors">
                                        🗑️ מחק
                                    </button>
                                    ` : ''}
                                    <span id="arrow-${uniqueId}" class="text-white text-xl transition-transform duration-300">▼</span>
                                </div>
                            </div>
                        </div>

                        <div id="blessing-details-${uniqueId}" class="hidden p-4">
                            <div class="flex flex-wrap gap-2 mb-4">
                                <span class="bg-gradient-to-r from-purple-500 to-pink-600 text-white px-4 py-2 rounded-2xl text-sm font-bold shadow-md">
                                    🏷️ ${blessing.category}
                                </span>
                            </div>
                            
                            <div class="bg-yellow-50 p-4 rounded-2xl mb-3 border border-yellow-200">
                                <div class="text-sm font-bold text-yellow-700 mb-2">📜 נוסח הברכה/תפילה</div>
                                <div class="text-sm text-yellow-600 whitespace-pre-line bg-white p-3 rounded-xl border border-yellow-200 font-hebrew leading-relaxed">${blessing.text}</div>
                            </div>
                            
                            ${blessing.notes ? `
                            <div class="bg-gray-50 p-4 rounded-2xl border border-gray-200">
                                <div class="text-sm font-bold text-gray-700 mb-2">📝 הערות</div>
                                <div class="text-sm text-gray-600 bg-white p-3 rounded-xl border">${blessing.notes}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Students data
        let students = [
            {
                id: 1,
                name: "דוד כהן",
                phone: "050-1234567",
                parentPhone: "052-9876543",
                parentName: "משה כהן",
                barMitzvahDate: "2024-12-15",
                currentParsha: "וירא",
                readingLevel: "ראשון + מפטיר",
                notes: "תלמיד מוכשר, מתקדם מהר",
                lessons: [
                    { date: "2024-11-20", time: "16:00", topic: "קריאת התורה - פרשת וירא", completed: true },
                    { date: "2024-11-27", time: "16:00", topic: "הפטרה ומפטיר", completed: false }
                ]
            },
            {
                id: 2,
                name: "אליהו מזרחי",
                phone: "054-5555555",
                parentPhone: "053-7777777",
                parentName: "יעקב מזרחי",
                barMitzvahDate: "2025-01-10",
                currentParsha: "לך לך",
                readingLevel: "ראשון בלבד",
                notes: "צריך עבודה נוספת על הניקוד",
                lessons: [
                    { date: "2024-11-21", time: "17:00", topic: "תרגול קריאה", completed: true },
                    { date: "2024-11-28", time: "17:00", topic: "פרשת לך לך - עליה ראשונה", completed: false }
                ]
            },
            {
                id: 3,
                name: "רון אבני",
                phone: "052-8888888",
                parentPhone: "054-9999999",
                parentName: "דני אבני",
                barMitzvahDate: "2025-03-18",
                currentParsha: "בראשית",
                readingLevel: "ראשון + מפטיר",
                notes: "תלמיד מתקדם, יודע לנגן גיטרה",
                lessons: [
                    { date: "2024-11-22", time: "15:30", topic: "התחלת לימוד פרשת בראשית", completed: true },
                    { date: "2024-11-29", time: "15:30", topic: "המשך פרשת בראשית", completed: false }
                ]
            }
        ];

        let editingStudent = null;
        let editingLesson = null;
        let editingLink = null;
        let studentsEditMode = false;

        // Sync students with events
        function syncStudentsWithEvents() {
            students.forEach(student => {
                const relatedEvent = events.find(event => 
                    event.name === student.name && event.isStudent
                );
                
                if (relatedEvent) {
                    // Update student data from event
                    student.parentPhone = relatedEvent.parentPhone;
                    student.parentName = relatedEvent.parentName;
                    student.barMitzvahDate = relatedEvent.date;
                }
            });
        }

        function renderStudents() {
            // Sync with events before rendering
            syncStudentsWithEvents();
            
            const container = document.getElementById('studentsContainer');
            
            if (students.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">👤</div>
                        <h3 class="text-xl font-bold text-gray-600 mb-2">לא נמצאו תלמידים</h3>
                        <p class="text-gray-500">השתמש בכפתור "הוסף תלמיד" כדי להתחיל</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="p-4 sm:p-6">
                    <div class="mb-6 flex gap-3">
                        <button onclick="showAddStudentForm()" class="bg-gradient-to-r from-orange-600 to-red-600 text-white px-6 py-3 rounded-2xl hover:from-orange-700 hover:to-red-700 transition-all shadow-lg flex items-center">
                            <span class="ml-2">➕</span>
                            <span class="font-medium">הוסף תלמיד חדש</span>
                        </button>
                        <button onclick="toggleStudentsEditMode()" class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-3 rounded-2xl hover:from-blue-700 hover:to-indigo-700 transition-all shadow-lg flex items-center">
                            <span class="ml-2">${studentsEditMode ? '👁️' : '✏️'}</span>
                            <span class="font-medium">${studentsEditMode ? 'מצב צפייה' : 'מצב עריכה'}</span>
                        </button>
                    </div>
                    
                    <div class="space-y-6">
                        ${students.map((student, index) => {
                            const gradientClass = `card-gradient-${(index % 6) + 1}`;
                            const nextLesson = student.lessons.find(l => !l.completed);
                            const barMitzvahDate = new Date(student.barMitzvahDate);
                            const today = new Date();
                            const daysUntilBarMitzvah = Math.ceil((barMitzvahDate - today) / (1000 * 60 * 60 * 24));
                            
                            return `
                                <div class="bg-white rounded-3xl shadow-lg border border-gray-100 overflow-hidden">
                                    <div class="${gradientClass} p-4 text-white">
                                        <div class="flex justify-between items-center">
                                            <div class="flex items-center">
                                                <span class="text-2xl ml-3">👤</span>
                                                <div>
                                                    <h3 class="text-xl font-bold">${student.name}</h3>
                                                    <p class="text-sm opacity-90">בר מצווה: ${barMitzvahDate.toLocaleDateString('he-IL')}</p>
                                                </div>
                                            </div>
                                            <div class="flex items-center space-x-2 space-x-reverse">
                                                ${daysUntilBarMitzvah > 0 ? `
                                                <span class="bg-white bg-opacity-20 text-white px-3 py-1 rounded-full text-xs font-medium">
                                                    ${daysUntilBarMitzvah} ימים
                                                </span>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="p-4 space-y-4">
                                        <!-- Student Info -->
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                            <div class="bg-blue-50 p-3 rounded-xl border border-blue-200">
                                                <div class="text-sm font-bold text-blue-700 mb-1">📖 פרשה נוכחית</div>
                                                <div class="text-blue-600 font-medium">${student.currentParsha}</div>
                                                <div class="text-xs text-blue-500 mt-1">${student.readingLevel}</div>
                                            </div>
                                            
                                            <div class="bg-green-50 p-3 rounded-xl border border-green-200">
                                                <div class="text-sm font-bold text-green-700 mb-1">📞 יצירת קשר</div>
                                                <div class="space-y-1">
                                                    <button onclick="openWhatsApp('${student.phone}', '${student.name}')" class="text-green-600 hover:text-green-800 text-sm flex items-center transition-colors">
                                                        <span class="ml-1">💬</span>
                                                        תלמיד: ${student.phone}
                                                    </button>
                                                    <button onclick="openWhatsApp('${student.parentPhone}', '${student.parentName}')" class="text-green-600 hover:text-green-800 text-sm flex items-center transition-colors">
                                                        <span class="ml-1">👨‍👩‍👦</span>
                                                        הורה: ${student.parentPhone}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Next Lesson -->
                                        ${nextLesson ? `
                                        <div class="bg-purple-50 p-3 rounded-xl border border-purple-200">
                                            <div class="text-sm font-bold text-purple-700 mb-2">⏰ השיעור הבא</div>
                                            <div class="flex justify-between items-center">
                                                <div>
                                                    <div class="text-purple-600 font-medium">${new Date(nextLesson.date).toLocaleDateString('he-IL')} בשעה ${nextLesson.time}</div>
                                                    <div class="text-xs text-purple-500">${nextLesson.topic}</div>
                                                </div>
                                                <button onclick="addToGoogleCalendar('${nextLesson.date}', '${nextLesson.time}', '${nextLesson.topic}', '${student.name}')" class="bg-purple-600 text-white px-3 py-1 rounded-lg text-xs hover:bg-purple-700 transition-colors">
                                                    📅 גוגל קלנדר
                                                </button>
                                            </div>
                                        </div>
                                        ` : ''}
                                        
                                        <!-- Notes -->
                                        ${student.notes ? `
                                        <div class="bg-yellow-50 p-3 rounded-xl border border-yellow-200">
                                            <div class="text-sm font-bold text-yellow-700 mb-1">📝 הערות</div>
                                            <div class="text-yellow-600 text-sm">${student.notes}</div>
                                        </div>
                                        ` : ''}
                                        
                                        <!-- Action Buttons - Only show in edit mode -->
                                        ${studentsEditMode ? `
                                        <div class="flex gap-2 pt-2">
                                            <button onclick="editStudent(${student.id})" class="flex-1 bg-gradient-to-r from-orange-600 to-red-600 text-white px-4 py-2 rounded-xl hover:from-orange-700 hover:to-red-700 transition-all text-sm font-medium">
                                                ✏️ עריכת פרטים
                                            </button>
                                            <button onclick="showLessonsModal(${student.id})" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-4 py-2 rounded-xl hover:from-blue-700 hover:to-indigo-700 transition-all text-sm font-medium">
                                                📚 ניהול שיעורים
                                            </button>
                                            <button onclick="scheduleLesson(${student.id})" class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 text-white px-4 py-2 rounded-xl hover:from-green-700 hover:to-emerald-700 transition-all text-sm font-medium">
                                                ➕ קבע שיעור
                                            </button>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        // Event Management Functions
        function showAddEventForm() {
            editingEvent = null;
            showEventModal();
        }

        function editEvent(eventId) {
            editingEvent = events.find(e => e.id === eventId);
            showEventModal();
        }

        function showEventModal() {
            const isEditing = editingEvent !== null;
            const event = editingEvent || { 
                name: '', date: '', time: '10:00', guestArrivalTime: '09:30', eventStartTime: '10:00',
                location: '', wazeLink: '', package: 'חבילה בסיסית', keyboardist: false, drummers: 0,
                isStudent: false, price: 2000, parentPhone: '', parentName: '', notes: '',
                photosLink: '', videosLink: ''
            };
            
            const modalHtml = `
                <div id="eventModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full max-h-[85vh] overflow-y-auto">
                        <div class="bg-gradient-to-l from-blue-600 to-indigo-600 text-white p-6 rounded-t-3xl">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold">${isEditing ? 'עריכת אירוע' : 'הוספת אירוע חדש'}</h3>
                                <button onclick="closeEventModal()" class="text-white hover:text-gray-200 text-2xl font-bold">×</button>
                            </div>
                        </div>
                        
                        <div class="p-6 space-y-4">
                            <!-- Basic Info -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">שם בר המצווה</label>
                                    <input type="text" id="eventName" value="${event.name}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">תאריך האירוע</label>
                                    <input type="date" id="eventDate" value="${event.date}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                            </div>
                            
                            <!-- Times -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">שעת הגעת אורחים</label>
                                    <input type="time" id="eventGuestArrival" value="${event.guestArrivalTime}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">שעת תחילת האירוע</label>
                                    <input type="time" id="eventStartTime" value="${event.eventStartTime}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                            </div>
                            
                            <!-- Location -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">מיקום האירוע</label>
                                    <input type="text" id="eventLocation" value="${event.location}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">קישור Waze</label>
                                    <input type="url" id="eventWazeLink" value="${event.wazeLink}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                            </div>
                            
                            <!-- Package and Price -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">סוג החבילה</label>
                                    <select id="eventPackage" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <option value="חבילה בסיסית" ${event.package === 'חבילה בסיסית' ? 'selected' : ''}>חבילה בסיסית</option>
                                        <option value="חבילה מורחבת" ${event.package === 'חבילה מורחבת' ? 'selected' : ''}>חבילה מורחבת</option>
                                        <option value="חבילה חגיגית" ${event.package === 'חבילה חגיגית' ? 'selected' : ''}>חבילה חגיגית</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">מחיר (₪)</label>
                                    <input type="number" id="eventPrice" value="${event.price}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                            </div>
                            
                            <!-- Musical Accompaniment -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="flex items-center">
                                    <input type="checkbox" id="eventKeyboardist" ${event.keyboardist ? 'checked' : ''} class="ml-2 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                                    <label for="eventKeyboardist" class="text-sm font-medium text-gray-700">קלידן</label>
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">מספר מתופפים</label>
                                    <input type="number" id="eventDrummers" value="${event.drummers}" min="0" max="5" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                            </div>
                            
                            <!-- Contact Info -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">שם ההורה</label>
                                    <input type="text" id="eventParentName" value="${event.parentName}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">טלפון הורה</label>
                                    <input type="tel" id="eventParentPhone" value="${event.parentPhone}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                            </div>
                            
                            <!-- Additional Options -->
                            <div class="flex items-center">
                                <input type="checkbox" id="eventIsStudent" ${event.isStudent ? 'checked' : ''} class="ml-2 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                                <label for="eventIsStudent" class="text-sm font-medium text-gray-700">תלמיד</label>
                            </div>
                            
                            <!-- Notes -->
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">הערות</label>
                                <textarea id="eventNotes" rows="3" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">${event.notes}</textarea>
                            </div>
                            
                            <!-- Media Links -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">קישור תמונות</label>
                                    <input type="url" id="eventPhotosLink" value="${event.photosLink}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">קישור סרטונים</label>
                                    <input type="url" id="eventVideosLink" value="${event.videosLink}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="flex gap-3 pt-4">
                                <button onclick="saveEvent()" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-3 rounded-xl hover:from-blue-700 hover:to-indigo-700 transition-all font-medium">
                                    ${isEditing ? 'עדכן אירוע' : 'הוסף אירוע'}
                                </button>
                                <button onclick="closeEventModal()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-all font-medium">
                                    ביטול
                                </button>
                                ${isEditing ? `
                                <button onclick="deleteEvent(${event.id})" class="px-6 py-3 bg-red-600 text-white rounded-xl hover:bg-red-700 transition-all font-medium">
                                    מחק
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeEventModal() {
            const modal = document.getElementById('eventModal');
            if (modal) modal.remove();
            editingEvent = null;
        }

        function saveEvent() {
            const name = document.getElementById('eventName').value.trim();
            const date = document.getElementById('eventDate').value;
            const guestArrivalTime = document.getElementById('eventGuestArrival').value;
            const eventStartTime = document.getElementById('eventStartTime').value;
            const location = document.getElementById('eventLocation').value.trim();
            const wazeLink = document.getElementById('eventWazeLink').value.trim();
            const package = document.getElementById('eventPackage').value;
            const price = parseInt(document.getElementById('eventPrice').value) || 0;
            const keyboardist = document.getElementById('eventKeyboardist').checked;
            const drummers = parseInt(document.getElementById('eventDrummers').value) || 0;
            const parentName = document.getElementById('eventParentName').value.trim();
            const parentPhone = document.getElementById('eventParentPhone').value.trim();
            const isStudent = document.getElementById('eventIsStudent').checked;
            const notes = document.getElementById('eventNotes').value.trim();
            const photosLink = document.getElementById('eventPhotosLink').value.trim();
            const videosLink = document.getElementById('eventVideosLink').value.trim();
            
            if (!name || !date || !location || !parentName || !parentPhone) {
                alert('אנא מלא את כל השדות הנדרשים');
                return;
            }
            
            if (editingEvent) {
                // Update existing event
                const index = events.findIndex(e => e.id === editingEvent.id);
                events[index] = {
                    ...editingEvent,
                    name, date, time: eventStartTime, guestArrivalTime, eventStartTime,
                    location, wazeLink, package, price, keyboardist, drummers,
                    parentName, parentPhone, isStudent, notes, photosLink, videosLink
                };
            } else {
                // Add new event
                const newId = Math.max(...events.map(e => e.id), 0) + 1;
                events.push({
                    id: newId,
                    name, date, time: eventStartTime, guestArrivalTime, eventStartTime,
                    location, wazeLink, package, price, keyboardist, drummers,
                    parentName, parentPhone, isStudent, notes, photosLink, videosLink
                });
            }
            
            closeEventModal();
            renderEvents();
            
            // Sync students if this is a student event
            if (currentPage === 'admin') {
                renderStudents();
            }
        }

        function deleteEvent(eventId) {
            if (!confirm('האם אתה בטוח שברצונך למחוק את האירוע?')) return;
            
            const index = events.findIndex(e => e.id === eventId);
            if (index > -1) {
                events.splice(index, 1);
                renderEvents();
            }
        }

        // Event Details Modal
        function showEventDetails(eventId) {
            const event = events.find(e => e.id === eventId);
            if (!event) return;

            const modalHtml = `
                <div id="eventDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full max-h-[85vh] overflow-y-auto">
                        <div class="bg-gradient-to-l from-blue-600 to-indigo-700 text-white p-6 rounded-t-3xl">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold">פרטי האירוע - ${event.name}</h3>
                                <button onclick="closeEventDetailsModal()" class="text-white hover:text-gray-200 text-2xl font-bold">×</button>
                            </div>
                        </div>
                        
                        <div class="p-4 space-y-3">
                            <div class="grid grid-cols-1 gap-3">
                                <!-- Date Section -->
                                <div class="bg-gradient-to-br from-blue-500 to-indigo-600 text-white p-3 rounded-lg shadow-sm">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <div class="bg-white bg-opacity-20 p-2 rounded-full ml-3">
                                                <span class="text-2xl">📅</span>
                                            </div>
                                            <div>
                                                <div class="text-xl font-bold">${new Date(event.date).toLocaleDateString('he-IL', {
                                                    day: 'numeric',
                                                    month: 'long',
                                                    year: 'numeric'
                                                })}</div>
                                                <div class="text-blue-100 text-sm font-medium">${new Date(event.date).toLocaleDateString('he-IL', { weekday: 'long' })}</div>
                                            </div>
                                        </div>
                                        <div class="bg-white bg-opacity-20 p-2 rounded-full cursor-pointer hover:bg-opacity-30 transition-all" onclick="addEventToGoogleCalendar(${event.id})">
                                            <span class="text-xl">📅</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-gradient-to-br from-green-500 to-emerald-600 text-white p-3 rounded-lg shadow-sm">
                                    <div class="flex items-center mb-3">
                                        <span class="text-lg ml-2">⏰</span>
                                        <span class="font-bold">זמני האירוע</span>
                                    </div>
                                    <div class="space-y-3">
                                        <!-- Guest Arrival Time -->
                                        <div class="bg-white bg-opacity-20 p-3 rounded-lg">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center">
                                                    <span class="text-lg ml-2">👥</span>
                                                    <div>
                                                        <div class="font-bold text-sm">הגעת אורחים</div>
                                                        <div class="text-xs opacity-80">זמן התכנסות</div>
                                                    </div>
                                                </div>
                                                <div class="text-lg font-bold">${event.guestArrivalTime}</div>
                                            </div>
                                        </div>
                                        
                                        <!-- Event Start Time -->
                                        <div class="bg-white bg-opacity-20 p-3 rounded-lg">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center">
                                                    <span class="text-lg ml-2">🎊</span>
                                                    <div>
                                                        <div class="font-bold text-sm">תחילת האירוע</div>
                                                        <div class="text-xs opacity-80">זמן התחלה רשמי</div>
                                                    </div>
                                                </div>
                                                <div class="text-lg font-bold">${event.eventStartTime}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="bg-gradient-to-br from-purple-500 to-indigo-600 text-white p-3 rounded-lg shadow-sm">
                                    <div class="flex items-center mb-2">
                                        <span class="text-lg ml-2">📍</span>
                                        <span class="font-bold">מיקום האירוע</span>
                                    </div>
                                    <div class="space-y-2 text-sm">
                                        <div>🏛️ מקום: ${event.location}</div>
                                        <div class="cursor-pointer hover:text-purple-200 transition-colors" onclick="openWaze('${event.wazeLink}')">🗺️ פתח ב-Waze</div>
                                    </div>
                                </div>
                                
                                <div class="bg-gradient-to-br from-orange-500 to-red-500 text-white p-3 rounded-lg shadow-sm">
                                    <div class="flex items-center mb-2">
                                        <span class="text-lg ml-2">📦</span>
                                        <span class="font-bold">פרטי החבילה</span>
                                    </div>
                                    <div class="space-y-1">
                                        <div class="bg-white bg-opacity-20 p-2 rounded-lg">
                                            <div class="font-bold text-sm">${event.package}</div>
                                        </div>
                                        ${isLoggedIn ? `
                                        <div class="bg-white bg-opacity-20 p-2 rounded-lg">
                                            <div class="text-sm font-bold">מחיר: ₪${event.price.toLocaleString()}</div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                                
                                <div class="bg-gradient-to-br from-indigo-500 to-purple-600 text-white p-3 rounded-lg shadow-sm">
                                    <div class="flex items-center mb-2">
                                        <span class="text-lg ml-2">🎵</span>
                                        <span class="font-bold">ליווי מוסיקלי</span>
                                    </div>
                                    <div class="space-y-1">
                                        <div class="bg-white bg-opacity-20 p-2 rounded-lg">
                                            <div class="text-sm">🎹 קלידן: ${event.keyboardist ? 'כלול' : 'לא כלול'} • 🥁 ${event.drummers > 0 ? `${event.drummers} מתופפים` : 'ללא'}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                ${isLoggedIn ? `
                                <div class="bg-gradient-to-br from-cyan-500 to-blue-600 text-white p-3 rounded-lg shadow-sm">
                                    <div class="flex items-center mb-2">
                                        <span class="text-lg ml-2">👨‍👩‍👦</span>
                                        <span class="font-bold">פרטי הקשר</span>
                                    </div>
                                    <div class="space-y-2 text-sm">
                                        <div>👤 שם ההורה: ${event.parentName}</div>
                                        <div class="cursor-pointer hover:text-blue-200 transition-colors" onclick="openWhatsApp('${event.parentPhone}', '${event.parentName}')">📞 טלפון: ${event.parentPhone}</div>
                                    </div>
                                </div>
                                ` : ''}
                                
                                ${event.notes ? `
                                <div class="bg-gradient-to-br from-yellow-500 to-amber-600 text-white p-3 rounded-lg shadow-sm">
                                    <div class="flex items-center mb-2">
                                        <span class="text-lg ml-2">📝</span>
                                        <span class="font-bold">הערות</span>
                                    </div>
                                    <div class="text-sm">${event.notes}</div>
                                </div>
                                ` : ''}
                                
                                <div class="bg-gradient-to-br from-pink-500 to-rose-600 text-white p-3 rounded-lg shadow-sm">
                                    <div class="flex items-center mb-2">
                                        <span class="text-lg ml-2">📁</span>
                                        <span class="font-bold">תמונות וסרטונים</span>
                                        ${isLoggedIn ? `<button onclick="editEventLinks(${event.id})" class="mr-auto bg-white bg-opacity-20 text-white px-3 py-1 rounded-lg text-sm hover:bg-opacity-30 transition-colors">✏️ עריכה</button>` : ''}
                                    </div>
                                    <div class="space-y-3">
                                        <button onclick="openGoogleDrive('${event.photosLink}')" class="w-full bg-gradient-to-r from-pink-600 to-rose-700 text-white px-4 py-3 rounded-xl hover:from-pink-700 hover:to-rose-800 transition-all flex items-center justify-center shadow-md ${!event.photosLink ? 'opacity-50 cursor-not-allowed' : ''}">
                                            <span class="ml-2">📸</span>
                                            <span class="font-medium">תמונות מהאירוע</span>
                                        </button>
                                        
                                        <button onclick="openGoogleDrive('${event.videosLink}')" class="w-full bg-gradient-to-r from-red-600 to-pink-700 text-white px-4 py-3 rounded-xl hover:from-red-700 hover:to-pink-800 transition-all flex items-center justify-center shadow-md ${!event.videosLink ? 'opacity-50 cursor-not-allowed' : ''}">
                                            <span class="ml-2">🎥</span>
                                            <span class="font-medium">סרטונים מהאירוع</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="pt-2">
                                <button onclick="closeEventDetailsModal()" class="w-full bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition-all font-medium text-sm">
                                    סגור
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeEventDetailsModal() {
            const modal = document.getElementById('eventDetailsModal');
            if (modal) modal.remove();
        }

        function editEventLinks(eventId) {
            const event = events.find(e => e.id === eventId);
            if (!event) return;

            const modalHtml = `
                <div id="editLinksModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full">
                        <div class="bg-gradient-to-l from-purple-600 to-pink-600 text-white p-6 rounded-t-3xl">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold">עריכת קישורי גוגל דרייב</h3>
                                <button onclick="closeEditLinksModal()" class="text-white hover:text-gray-200 text-2xl font-bold">×</button>
                            </div>
                        </div>
                        
                        <div class="p-4 space-y-3">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">קישור תמונות</label>
                                <input type="url" id="photosLinkInput" value="${event.photosLink}" placeholder="https://drive.google.com/drive/folders/..." class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">קישור סרטונים</label>
                                <input type="url" id="videosLinkInput" value="${event.videosLink}" placeholder="https://drive.google.com/drive/folders/..." class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                            
                            <div class="flex gap-3 pt-4">
                                <button onclick="saveEventLinks(${event.id})" class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-3 rounded-xl hover:from-purple-700 hover:to-pink-700 transition-all font-medium">
                                    שמור שינויים
                                </button>
                                <button onclick="closeEditLinksModal()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-all font-medium">
                                    ביטול
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeEditLinksModal() {
            const modal = document.getElementById('editLinksModal');
            if (modal) modal.remove();
        }

        function saveEventLinks(eventId) {
            const photosLink = document.getElementById('photosLinkInput').value.trim();
            const videosLink = document.getElementById('videosLinkInput').value.trim();
            
            const eventIndex = events.findIndex(e => e.id === eventId);
            if (eventIndex > -1) {
                events[eventIndex].photosLink = photosLink;
                events[eventIndex].videosLink = videosLink;
                
                closeEditLinksModal();
                closeEventDetailsModal();
                renderEvents();
                
                // Reopen the event details modal to show updated links
                setTimeout(() => showEventDetails(eventId), 100);
            }
        }

        // Utility functions
        function openWaze(wazeLink) {
            window.open(wazeLink, '_blank');
        }

        function openGoogleDrive(driveLink) {
            if (driveLink && driveLink.trim()) {
                window.open(driveLink, '_blank');
            } else {
                alert('קישור לא זמין');
            }
        }

        function toggleSongDetails(songId) {
            const detailsElement = document.getElementById(`song-details-${songId}`);
            const arrowElement = document.getElementById(`arrow-${songId}`);
            
            if (detailsElement.classList.contains('hidden')) {
                detailsElement.classList.remove('hidden');
                arrowElement.style.transform = 'rotate(180deg)';
            } else {
                detailsElement.classList.add('hidden');
                arrowElement.style.transform = 'rotate(0deg)';
            }
        }

        function toggleBlessingDetails(blessingId) {
            const detailsElement = document.getElementById(`blessing-details-${blessingId}`);
            const arrowElement = document.getElementById(`arrow-${blessingId}`);
            
            if (detailsElement.classList.contains('hidden')) {
                detailsElement.classList.remove('hidden');
                arrowElement.style.transform = 'rotate(180deg)';
            } else {
                detailsElement.classList.add('hidden');
                arrowElement.style.transform = 'rotate(0deg)';
            }
        }

        function toggleCategoryDetails(categoryId) {
            const contentElement = document.getElementById(`category-content-${categoryId}`);
            const arrowElement = document.getElementById(`category-arrow-${categoryId}`);
            
            if (contentElement.classList.contains('hidden')) {
                contentElement.classList.remove('hidden');
                arrowElement.style.transform = 'rotate(180deg)';
            } else {
                contentElement.classList.add('hidden');
                arrowElement.style.transform = 'rotate(0deg)';
            }
        }

        function callParent(phoneNumber) {
            window.open(`tel:${phoneNumber}`, '_self');
        }

        // Prayer Songs Management
        function showAddPrayerSongForm() {
            editingPrayerSong = null;
            showPrayerSongModal();
        }

        function editPrayerSong(songId) {
            editingPrayerSong = prayerSongs.find(s => s.id === songId);
            showPrayerSongModal();
        }

        function showPrayerSongModal() {
            const isEditing = editingPrayerSong !== null;
            const song = editingPrayerSong || { name: '', key: '', tempo: 120, transpose: 0, chords: '', lyrics: '', category: '' };
            
            const modalHtml = `
                <div id="songModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full max-h-[85vh] overflow-y-auto">
                        <div class="bg-gradient-to-l from-purple-600 to-pink-600 text-white p-6 rounded-t-3xl">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold">${isEditing ? 'עריכת שיר תפילה' : 'הוספת שיר תפילה חדש'}</h3>
                                <button onclick="closePrayerSongModal()" class="text-white hover:text-gray-200 text-2xl font-bold">×</button>
                            </div>
                        </div>
                        
                        <div class="p-4 space-y-3">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">שם השיר</label>
                                <input type="text" id="songName" value="${song.name}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">סולם</label>
                                    <input type="text" id="songKey" value="${song.key}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">קטגוריה</label>
                                    <input type="text" id="songCategory" value="${song.category}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">טמפו</label>
                                    <input type="number" id="songTempo" value="${song.tempo}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">טרנספוז</label>
                                    <input type="number" id="songTranspose" value="${song.transpose}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">אקורדים</label>
                                <textarea id="songChords" rows="3" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">${song.chords}</textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">מילים</label>
                                <textarea id="songLyrics" rows="6" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-transparent">${song.lyrics}</textarea>
                            </div>
                            
                            <div class="flex gap-3 pt-4">
                                <button onclick="savePrayerSong()" class="flex-1 bg-gradient-to-r from-purple-600 to-pink-600 text-white px-6 py-3 rounded-xl hover:from-purple-700 hover:to-pink-700 transition-all font-medium">
                                    ${isEditing ? 'עדכן שיר' : 'הוסף שיר'}
                                </button>
                                <button onclick="closePrayerSongModal()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-all font-medium">
                                    ביטול
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closePrayerSongModal() {
            const modal = document.getElementById('songModal');
            if (modal) modal.remove();
            editingPrayerSong = null;
        }

        function savePrayerSong() {
            const name = document.getElementById('songName').value.trim();
            const key = document.getElementById('songKey').value.trim();
            const category = document.getElementById('songCategory').value.trim();
            const tempo = parseInt(document.getElementById('songTempo').value) || 120;
            const transpose = parseInt(document.getElementById('songTranspose').value) || 0;
            const chords = document.getElementById('songChords').value.trim();
            const lyrics = document.getElementById('songLyrics').value.trim();
            
            if (!name || !key || !category) {
                alert('אנא מלא את כל השדות הנדרשים');
                return;
            }
            
            if (editingPrayerSong) {
                // Update existing song
                const index = prayerSongs.findIndex(s => s.id === editingPrayerSong.id);
                prayerSongs[index] = {
                    ...editingPrayerSong,
                    name, key, category, tempo, transpose, chords, lyrics
                };
            } else {
                // Add new song
                const newId = Math.max(...prayerSongs.map(s => s.id), 0) + 1;
                prayerSongs.push({
                    id: newId,
                    name, key, category, tempo, transpose, chords, lyrics
                });
            }
            
            closePrayerSongModal();
            renderPrayerSongs();
        }

        function deletePrayerSong(songId) {
            if (!confirm('האם אתה בטוח שברצונך למחוק את השיר?')) return;
            
            const index = prayerSongs.findIndex(s => s.id === songId);
            if (index > -1) {
                prayerSongs.splice(index, 1);
                renderPrayerSongs();
            }
        }

        // Meal Songs Management
        function showAddMealSongForm() {
            editingMealSong = null;
            showMealSongModal();
        }

        function editMealSong(songId) {
            editingMealSong = mealSongs.find(s => s.id === songId);
            showMealSongModal();
        }

        function showMealSongModal() {
            const isEditing = editingMealSong !== null;
            const song = editingMealSong || { name: '', key: '', tempo: 120, transpose: 0, chords: '', lyrics: '', category: '' };
            
            const modalHtml = `
                <div id="mealSongModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full max-h-[85vh] overflow-y-auto">
                        <div class="bg-gradient-to-l from-green-600 to-emerald-600 text-white p-6 rounded-t-3xl">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold">${isEditing ? 'עריכת שיר סעודה' : 'הוספת שיר סעודה חדש'}</h3>
                                <button onclick="closeMealSongModal()" class="text-white hover:text-gray-200 text-2xl font-bold">×</button>
                            </div>
                        </div>
                        
                        <div class="p-4 space-y-3">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">שם השיר</label>
                                <input type="text" id="mealSongName" value="${song.name}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">סולם</label>
                                    <input type="text" id="mealSongKey" value="${song.key}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">קטגוריה</label>
                                    <input type="text" id="mealSongCategory" value="${song.category}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">טמפו</label>
                                    <input type="number" id="mealSongTempo" value="${song.tempo}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">טרנספוז</label>
                                    <input type="number" id="mealSongTranspose" value="${song.transpose}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">אקורדים</label>
                                <textarea id="mealSongChords" rows="3" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">${song.chords}</textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">מילים</label>
                                <textarea id="mealSongLyrics" rows="6" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">${song.lyrics}</textarea>
                            </div>
                            
                            <div class="flex gap-3 pt-4">
                                <button onclick="saveMealSong()" class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 text-white px-6 py-3 rounded-xl hover:from-green-700 hover:to-emerald-700 transition-all font-medium">
                                    ${isEditing ? 'עדכן שיר' : 'הוסף שיר'}
                                </button>
                                <button onclick="closeMealSongModal()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-all font-medium">
                                    ביטול
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeMealSongModal() {
            const modal = document.getElementById('mealSongModal');
            if (modal) modal.remove();
            editingMealSong = null;
        }

        function saveMealSong() {
            const name = document.getElementById('mealSongName').value.trim();
            const key = document.getElementById('mealSongKey').value.trim();
            const category = document.getElementById('mealSongCategory').value.trim();
            const tempo = parseInt(document.getElementById('mealSongTempo').value) || 120;
            const transpose = parseInt(document.getElementById('mealSongTranspose').value) || 0;
            const chords = document.getElementById('mealSongChords').value.trim();
            const lyrics = document.getElementById('mealSongLyrics').value.trim();
            
            if (!name || !key || !category) {
                alert('אנא מלא את כל השדות הנדרשים');
                return;
            }
            
            if (editingMealSong) {
                // Update existing song
                const index = mealSongs.findIndex(s => s.id === editingMealSong.id);
                mealSongs[index] = {
                    ...editingMealSong,
                    name, key, category, tempo, transpose, chords, lyrics
                };
            } else {
                // Add new song
                const newId = Math.max(...mealSongs.map(s => s.id), 0) + 1;
                mealSongs.push({
                    id: newId,
                    name, key, category, tempo, transpose, chords, lyrics
                });
            }
            
            closeMealSongModal();
            renderMealSongs();
        }

        function deleteMealSong(songId) {
            if (!confirm('האם אתה בטוח שברצונך למחוק את השיר?')) return;
            
            const index = mealSongs.findIndex(s => s.id === songId);
            if (index > -1) {
                mealSongs.splice(index, 1);
                renderMealSongs();
            }
        }

        // Student Management Functions
        function showAddStudentForm() {
            editingStudent = null;
            showStudentModal();
        }

        function editStudent(studentId) {
            editingStudent = students.find(s => s.id === studentId);
            showStudentModal();
        }

        function showStudentModal() {
            const isEditing = editingStudent !== null;
            const student = editingStudent || { 
                name: '', phone: '', parentPhone: '', parentName: '', 
                barMitzvahDate: '', currentParsha: '', readingLevel: 'ראשון בלבד', notes: '' 
            };
            
            const modalHtml = `
                <div id="studentModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full max-h-[85vh] overflow-y-auto">
                        <div class="bg-gradient-to-l from-orange-600 to-red-600 text-white p-6 rounded-t-3xl">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold">${isEditing ? 'עריכת תלמיד' : 'הוספת תלמיד חדש'}</h3>
                                <button onclick="closeStudentModal()" class="text-white hover:text-gray-200 text-2xl font-bold">×</button>
                            </div>
                        </div>
                        
                        <div class="p-4 space-y-3">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">שם התלמיד</label>
                                <input type="text" id="studentName" value="${student.name}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">טלפון תלמיד</label>
                                    <input type="tel" id="studentPhone" value="${student.phone}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">תאריך בר מצווה</label>
                                    <input type="date" id="studentBarMitzvahDate" value="${student.barMitzvahDate}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">שם ההורה</label>
                                    <input type="text" id="studentParentName" value="${student.parentName}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">טלפון הורה</label>
                                    <input type="tel" id="studentParentPhone" value="${student.parentPhone}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">פרשה נוכחית</label>
                                    <input type="text" id="studentCurrentParsha" value="${student.currentParsha}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">רמת קריאה</label>
                                    <select id="studentReadingLevel" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent">
                                        <option value="ראשון בלבד" ${student.readingLevel === 'ראשון בלבד' ? 'selected' : ''}>ראשון בלבד</option>
                                        <option value="ראשון + מפטיר" ${student.readingLevel === 'ראשון + מפטיר' ? 'selected' : ''}>ראשון + מפטיר</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">הערות</label>
                                <textarea id="studentNotes" rows="3" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-transparent">${student.notes}</textarea>
                            </div>
                            
                            <div class="flex gap-3 pt-4">
                                <button onclick="saveStudent()" class="flex-1 bg-gradient-to-r from-orange-600 to-red-600 text-white px-6 py-3 rounded-xl hover:from-orange-700 hover:to-red-700 transition-all font-medium">
                                    ${isEditing ? 'עדכן תלמיד' : 'הוסף תלמיד'}
                                </button>
                                <button onclick="closeStudentModal()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-all font-medium">
                                    ביטול
                                </button>
                                ${isEditing ? `
                                <button onclick="deleteStudent(${student.id})" class="px-6 py-3 bg-red-600 text-white rounded-xl hover:bg-red-700 transition-all font-medium">
                                    מחק
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeStudentModal() {
            const modal = document.getElementById('studentModal');
            if (modal) modal.remove();
            editingStudent = null;
        }

        function saveStudent() {
            const name = document.getElementById('studentName').value.trim();
            const phone = document.getElementById('studentPhone').value.trim();
            const parentName = document.getElementById('studentParentName').value.trim();
            const parentPhone = document.getElementById('studentParentPhone').value.trim();
            const barMitzvahDate = document.getElementById('studentBarMitzvahDate').value;
            const currentParsha = document.getElementById('studentCurrentParsha').value.trim();
            const readingLevel = document.getElementById('studentReadingLevel').value;
            const notes = document.getElementById('studentNotes').value.trim();
            
            if (!name || !phone || !parentName || !parentPhone || !barMitzvahDate) {
                alert('אנא מלא את כל השדות הנדרשים');
                return;
            }
            
            if (editingStudent) {
                // Update existing student
                const index = students.findIndex(s => s.id === editingStudent.id);
                students[index] = {
                    ...editingStudent,
                    name, phone, parentName, parentPhone, barMitzvahDate, currentParsha, readingLevel, notes
                };
            } else {
                // Add new student
                const newId = Math.max(...students.map(s => s.id), 0) + 1;
                students.push({
                    id: newId,
                    name, phone, parentName, parentPhone, barMitzvahDate, currentParsha, readingLevel, notes,
                    lessons: []
                });
            }
            
            closeStudentModal();
            renderStudents();
        }

        function deleteStudent(studentId) {
            if (!confirm('האם אתה בטוח שברצונך למחוק את התלמיד? פעולה זו תמחק גם את כל השיעורים שלו.')) return;
            
            const index = students.findIndex(s => s.id === studentId);
            if (index > -1) {
                students.splice(index, 1);
                renderStudents();
            }
        }

        function toggleStudentsEditMode() {
            studentsEditMode = !studentsEditMode;
            renderStudents();
        }

        function scheduleLesson(studentId) {
            editingLesson = null;
            showLessonModal(studentId);
        }

        function showLessonModal(studentId, lessonIndex = null) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const isEditing = lessonIndex !== null;
            const lesson = isEditing ? student.lessons[lessonIndex] : { date: '', time: '', topic: '', completed: false };
            
            const modalHtml = `
                <div id="lessonModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full">
                        <div class="bg-gradient-to-l from-green-600 to-emerald-600 text-white p-6 rounded-t-3xl">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold">${isEditing ? 'עריכת שיעור' : 'קביעת שיעור חדש'}</h3>
                                <button onclick="closeLessonModal()" class="text-white hover:text-gray-200 text-2xl font-bold">×</button>
                            </div>
                            <p class="text-green-100 text-sm mt-1">תלמיד: ${student.name}</p>
                        </div>
                        
                        <div class="p-4 space-y-3">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">תאריך השיעור</label>
                                    <input type="date" id="lessonDate" value="${lesson.date}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">שעת השיעור</label>
                                    <input type="time" id="lessonTime" value="${lesson.time}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">נושא השיעור</label>
                                <input type="text" id="lessonTopic" value="${lesson.topic}" placeholder="לדוגמה: פרשת בראשית - עליה ראשונה" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-transparent">
                            </div>
                            
                            ${isEditing ? `
                            <div class="flex items-center">
                                <input type="checkbox" id="lessonCompleted" ${lesson.completed ? 'checked' : ''} class="ml-2 w-4 h-4 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500">
                                <label for="lessonCompleted" class="text-sm font-medium text-gray-700">השיעור הושלם</label>
                            </div>
                            ` : ''}
                            
                            <div class="flex gap-3 pt-4">
                                <button onclick="saveLesson(${studentId}, ${lessonIndex})" class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 text-white px-6 py-3 rounded-xl hover:from-green-700 hover:to-emerald-700 transition-all font-medium">
                                    ${isEditing ? 'עדכן שיעור' : 'קבע שיעור'}
                                </button>
                                <button onclick="closeLessonModal()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-all font-medium">
                                    ביטול
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeLessonModal() {
            const modal = document.getElementById('lessonModal');
            if (modal) modal.remove();
        }

        function saveLesson(studentId, lessonIndex) {
            const date = document.getElementById('lessonDate').value;
            const time = document.getElementById('lessonTime').value;
            const topic = document.getElementById('lessonTopic').value.trim();
            const completed = document.getElementById('lessonCompleted') ? document.getElementById('lessonCompleted').checked : false;
            
            if (!date || !time || !topic) {
                alert('אנא מלא את כל השדות');
                return;
            }
            
            const studentIndex = students.findIndex(s => s.id === studentId);
            if (studentIndex === -1) return;
            
            const lessonData = { date, time, topic, completed };
            
            if (lessonIndex !== null) {
                // Update existing lesson
                students[studentIndex].lessons[lessonIndex] = lessonData;
            } else {
                // Add new lesson
                students[studentIndex].lessons.push(lessonData);
                // Sort lessons by date
                students[studentIndex].lessons.sort((a, b) => new Date(a.date) - new Date(b.date));
            }
            
            closeLessonModal();
            renderStudents();
        }

        function showLessonsModal(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            const modalHtml = `
                <div id="lessonsListModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full max-h-[85vh] overflow-y-auto">
                        <div class="bg-gradient-to-l from-blue-600 to-indigo-600 text-white p-6 rounded-t-3xl">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold">שיעורים - ${student.name}</h3>
                                <button onclick="closeLessonsModal()" class="text-white hover:text-gray-200 text-2xl font-bold">×</button>
                            </div>
                        </div>
                        
                        <div class="p-4">
                            <div class="mb-4">
                                <button onclick="scheduleLesson(${studentId})" class="bg-gradient-to-r from-green-600 to-emerald-600 text-white px-4 py-2 rounded-xl hover:from-green-700 hover:to-emerald-700 transition-all flex items-center">
                                    <span class="ml-2">➕</span>
                                    <span>הוסף שיעור חדש</span>
                                </button>
                            </div>
                            
                            <div class="space-y-3">
                                ${student.lessons.length === 0 ? `
                                    <div class="text-center py-8">
                                        <div class="text-4xl mb-2">📚</div>
                                        <p class="text-gray-500">עדיין לא נקבעו שיעורים</p>
                                    </div>
                                ` : student.lessons.map((lesson, index) => `
                                    <div class="bg-gray-50 p-4 rounded-xl border ${lesson.completed ? 'border-green-200 bg-green-50' : 'border-gray-200'}">
                                        <div class="flex justify-between items-start">
                                            <div class="flex-1">
                                                <div class="flex items-center mb-2">
                                                    <span class="text-lg ml-2">${lesson.completed ? '✅' : '📅'}</span>
                                                    <span class="font-bold ${lesson.completed ? 'text-green-700' : 'text-gray-700'}">${new Date(lesson.date).toLocaleDateString('he-IL')} בשעה ${lesson.time}</span>
                                                </div>
                                                <div class="text-sm ${lesson.completed ? 'text-green-600' : 'text-gray-600'} mb-2">${lesson.topic}</div>
                                                ${lesson.completed ? '<div class="text-xs text-green-500 font-medium">השיעור הושלם</div>' : ''}
                                            </div>
                                            <div class="flex gap-2">
                                                <button onclick="editLesson(${studentId}, ${index})" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-xs hover:bg-blue-700 transition-colors">
                                                    ✏️ עריכה
                                                </button>
                                                <button onclick="deleteLesson(${studentId}, ${index})" class="bg-red-600 text-white px-3 py-1 rounded-lg text-xs hover:bg-red-700 transition-colors">
                                                    🗑️ מחק
                                                </button>
                                                ${!lesson.completed ? `
                                                <button onclick="addToGoogleCalendar('${lesson.date}', '${lesson.time}', '${lesson.topic}', '${student.name}')" class="bg-purple-600 text-white px-3 py-1 rounded-lg text-xs hover:bg-purple-700 transition-colors">
                                                    📅 קלנדר
                                                </button>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeLessonsModal() {
            const modal = document.getElementById('lessonsListModal');
            if (modal) modal.remove();
        }

        function editLesson(studentId, lessonIndex) {
            closeLessonsModal();
            showLessonModal(studentId, lessonIndex);
        }

        function deleteLesson(studentId, lessonIndex) {
            if (!confirm('האם אתה בטוח שברצונך למחוק את השיעור?')) return;
            
            const studentIndex = students.findIndex(s => s.id === studentId);
            if (studentIndex > -1) {
                students[studentIndex].lessons.splice(lessonIndex, 1);
                closeLessonsModal();
                showLessonsModal(studentId); // Reopen the modal to show updated list
            }
        }

        function openWhatsApp(phoneNumber, name) {
            const message = encodeURIComponent(`שלום ${name}, `);
            const whatsappUrl = `https://wa.me/972${phoneNumber.substring(1)}?text=${message}`;
            window.open(whatsappUrl, '_blank');
        }

        function toggleEventDetails(eventId) {
            const detailsElement = document.getElementById(`event-details-${eventId.replace('event-', '')}`);
            const arrowElement = document.getElementById(`event-arrow-${eventId.replace('event-', '')}`);
            
            if (detailsElement.classList.contains('hidden')) {
                detailsElement.classList.remove('hidden');
                arrowElement.style.transform = 'rotate(180deg)';
            } else {
                detailsElement.classList.add('hidden');
                arrowElement.style.transform = 'rotate(0deg)';
            }
        }

        function addEventToGoogleCalendar(eventId) {
            const event = events.find(e => e.id === eventId);
            if (!event) return;

            const eventDate = new Date(event.date);
            const startDateTime = new Date(`${event.date}T${event.eventStartTime}:00`);
            const endDateTime = new Date(startDateTime.getTime() + 3 * 60 * 60 * 1000); // 3 hours later
            
            const formatDate = (date) => {
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            };
            
            const title = encodeURIComponent(`בר מצווה - ${event.name}`);
            const details = encodeURIComponent(`
📍 מיקום: ${event.location}
👥 הגעת אורחים: ${event.guestArrivalTime}
🎊 תחילת האירוע: ${event.eventStartTime}
📦 חבילה: ${event.package}
🎵 ליווי מוסיקלי: ${event.keyboardist ? 'קלידן' : ''} ${event.drummers > 0 ? `+ ${event.drummers} מתופפים` : ''}
${event.notes ? `📝 הערות: ${event.notes}` : ''}
            `.trim());
            
            const location = encodeURIComponent(event.location);
            const startTime = formatDate(startDateTime);
            const endTime = formatDate(endDateTime);
            
            const googleCalendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${startTime}/${endTime}&details=${details}&location=${location}`;
            
            window.open(googleCalendarUrl, '_blank');
        }

        function addToGoogleCalendar(date, time, topic, studentName) {
            const startDateTime = new Date(`${date}T${time}:00`);
            const endDateTime = new Date(startDateTime.getTime() + 60 * 60 * 1000); // 1 hour later
            
            const formatDate = (date) => {
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            };
            
            const title = encodeURIComponent(`שיעור בר מצווה - ${studentName}`);
            const details = encodeURIComponent(`נושא: ${topic}\nתלמיד: ${studentName}`);
            const startTime = formatDate(startDateTime);
            const endTime = formatDate(endDateTime);
            
            const googleCalendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${startTime}/${endTime}&details=${details}`;
            
            window.open(googleCalendarUrl, '_blank');
        }

        // Blessings Management Functions
        function showAddBlessingForm() {
            editingBlessing = null;
            showBlessingModal();
        }

        function editBlessing(blessingId) {
            editingBlessing = blessings.find(b => b.id === blessingId);
            showBlessingModal();
        }

        function showBlessingModal() {
            const isEditing = editingBlessing !== null;
            const blessing = editingBlessing || { name: '', category: '', text: '', notes: '' };
            
            const modalHtml = `
                <div id="blessingModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full max-h-[85vh] overflow-y-auto">
                        <div class="bg-gradient-to-l from-yellow-600 to-amber-600 text-white p-6 rounded-t-3xl">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold">${isEditing ? 'עריכת ברכה/תפילה' : 'הוספת ברכה/תפילה חדשה'}</h3>
                                <button onclick="closeBlessingModal()" class="text-white hover:text-gray-200 text-2xl font-bold">×</button>
                            </div>
                        </div>
                        
                        <div class="p-4 space-y-3">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">שם הברכה/תפילה</label>
                                <input type="text" id="blessingName" value="${blessing.name}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">קטגוריה</label>
                                <input type="text" id="blessingCategory" value="${blessing.category}" placeholder="לדוגמה: ברכות התפילה" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">נוסח הברכה/תפילה</label>
                                <textarea id="blessingText" rows="6" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-transparent font-hebrew leading-relaxed" placeholder="הכנס כאן את נוסח הברכה או התפילה...">${blessing.text}</textarea>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">הערות (אופציונלי)</label>
                                <textarea id="blessingNotes" rows="3" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-transparent" placeholder="הערות נוספות על הברכה או התפילה...">${blessing.notes}</textarea>
                            </div>
                            
                            <div class="flex gap-3 pt-4">
                                <button onclick="saveBlessing()" class="flex-1 bg-gradient-to-r from-yellow-600 to-amber-600 text-white px-6 py-3 rounded-xl hover:from-yellow-700 hover:to-amber-700 transition-all font-medium">
                                    ${isEditing ? 'עדכן ברכה/תפילה' : 'הוסף ברכה/תפילה'}
                                </button>
                                <button onclick="closeBlessingModal()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-all font-medium">
                                    ביטול
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeBlessingModal() {
            const modal = document.getElementById('blessingModal');
            if (modal) modal.remove();
            editingBlessing = null;
        }

        function saveBlessing() {
            const name = document.getElementById('blessingName').value.trim();
            const category = document.getElementById('blessingCategory').value.trim();
            const text = document.getElementById('blessingText').value.trim();
            const notes = document.getElementById('blessingNotes').value.trim();
            
            if (!name || !category || !text) {
                alert('אנא מלא את כל השדות הנדרשים (שם, קטגוריה ונוסח)');
                return;
            }
            
            if (editingBlessing) {
                // Update existing blessing
                const index = blessings.findIndex(b => b.id === editingBlessing.id);
                blessings[index] = {
                    ...editingBlessing,
                    name, category, text, notes
                };
            } else {
                // Add new blessing
                const newId = Math.max(...blessings.map(b => b.id), 0) + 1;
                blessings.push({
                    id: newId,
                    name, category, text, notes
                });
            }
            
            closeBlessingModal();
            renderBlessings();
        }

        function deleteBlessing(blessingId) {
            if (!confirm('האם אתה בטוח שברצונך למחוק את הברכה/תפילה?')) return;
            
            const index = blessings.findIndex(b => b.id === blessingId);
            if (index > -1) {
                blessings.splice(index, 1);
                renderBlessings();
            }
        }

        // Equipment Management Functions
        function renderEquipment() {
            const container = document.getElementById('equipmentContainer');
            
            if (equipment.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">📦</div>
                        <h3 class="text-xl font-bold text-gray-600 mb-2">לא נמצאו פריטי ציוד</h3>
                        <p class="text-gray-500">השתמש בכפתור "הוסף פריט ציוד" כדי להתחיל</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="mb-6">
                    <button onclick="editAllEquipment()" class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-3 rounded-2xl hover:from-blue-700 hover:to-indigo-700 transition-all shadow-lg flex items-center">
                        <span class="ml-2">✏️</span>
                        <span class="font-medium">עריכת הרשימה</span>
                    </button>
                </div>
                
                <div class="bg-white border border-gray-200 rounded-2xl shadow-md p-6">
                    <div class="space-y-3">
                        ${equipment.map((item, index) => `
                            <div class="flex items-center p-3 bg-gray-50 rounded-xl border border-gray-200">
                                <span class="text-lg ml-3">📦</span>
                                <span class="text-gray-800 font-medium">${item.name}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function showAddEquipmentForm() {
            editingEquipment = null;
            showEquipmentModal();
        }

        function editAllEquipment() {
            showEquipmentListModal();
        }

        function editEquipment(equipmentId) {
            editingEquipment = equipment.find(e => e.id === equipmentId);
            showEquipmentModal();
        }

        function showEquipmentListModal() {
            const modalHtml = `
                <div id="equipmentListModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full max-h-[85vh] overflow-y-auto">
                        <div class="bg-gradient-to-l from-blue-600 to-indigo-600 text-white p-6 rounded-t-3xl">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold">עריכת רשימת הציוד</h3>
                                <button onclick="closeEquipmentListModal()" class="text-white hover:text-gray-200 text-2xl font-bold">×</button>
                            </div>
                        </div>
                        
                        <div class="p-4 space-y-3">
                            <div id="equipmentEditList" class="space-y-2">
                                ${equipment.map((item, index) => `
                                    <div class="flex items-center gap-2 p-3 bg-gray-50 rounded-xl border border-gray-200">
                                        <span class="text-lg">📦</span>
                                        <input type="text" value="${item.name}" data-id="${item.id}" class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                        <button onclick="removeEquipmentFromList(${item.id})" class="bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700 transition-colors">
                                            🗑️
                                        </button>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <button onclick="addEquipmentToList()" class="w-full bg-gray-200 text-gray-700 px-4 py-3 rounded-xl hover:bg-gray-300 transition-all flex items-center justify-center">
                                <span class="ml-2">➕</span>
                                <span>הוסף פריט חדש</span>
                            </button>
                            
                            <div class="flex gap-3 pt-4">
                                <button onclick="saveEquipmentList()" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-3 rounded-xl hover:from-blue-700 hover:to-indigo-700 transition-all font-medium">
                                    שמור שינויים
                                </button>
                                <button onclick="closeEquipmentListModal()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-all font-medium">
                                    ביטול
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function showEquipmentModal() {
            const isEditing = editingEquipment !== null;
            const item = editingEquipment || { name: '' };
            
            const modalHtml = `
                <div id="equipmentModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full">
                        <div class="bg-gradient-to-l from-gray-600 to-slate-600 text-white p-6 rounded-t-3xl">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold">${isEditing ? 'עריכת פריט ציוד' : 'הוספת פריט ציוד חדש'}</h3>
                                <button onclick="closeEquipmentModal()" class="text-white hover:text-gray-200 text-2xl font-bold">×</button>
                            </div>
                        </div>
                        
                        <div class="p-4 space-y-3">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">שם הפריט</label>
                                <input type="text" id="equipmentName" value="${item.name}" placeholder="לדוגמה: מיקרופון אלחוטי" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-gray-500 focus:border-transparent">
                            </div>
                            
                            <div class="flex gap-3 pt-4">
                                <button onclick="saveEquipment()" class="flex-1 bg-gradient-to-r from-gray-600 to-slate-600 text-white px-6 py-3 rounded-xl hover:from-gray-700 hover:to-slate-700 transition-all font-medium">
                                    ${isEditing ? 'עדכן פריט' : 'הוסף פריט'}
                                </button>
                                <button onclick="closeEquipmentModal()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-all font-medium">
                                    ביטול
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeEquipmentListModal() {
            const modal = document.getElementById('equipmentListModal');
            if (modal) modal.remove();
        }

        function addEquipmentToList() {
            const container = document.getElementById('equipmentEditList');
            const newId = Math.max(...equipment.map(e => e.id), 0) + 1;
            
            const newItemHtml = `
                <div class="flex items-center gap-2 p-3 bg-gray-50 rounded-xl border border-gray-200">
                    <span class="text-lg">📦</span>
                    <input type="text" value="" data-id="${newId}" placeholder="שם הפריט החדש" class="flex-1 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <button onclick="removeEquipmentFromList(${newId})" class="bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700 transition-colors">
                        🗑️
                    </button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', newItemHtml);
        }

        function removeEquipmentFromList(itemId) {
            const itemElement = document.querySelector(`input[data-id="${itemId}"]`).closest('div');
            itemElement.remove();
        }

        function saveEquipmentList() {
            const inputs = document.querySelectorAll('#equipmentEditList input');
            const newEquipment = [];
            
            inputs.forEach(input => {
                const name = input.value.trim();
                if (name) {
                    newEquipment.push({
                        id: parseInt(input.dataset.id),
                        name: name
                    });
                }
            });
            
            equipment.length = 0;
            equipment.push(...newEquipment);
            
            closeEquipmentListModal();
            renderEquipment();
        }

        function closeEquipmentModal() {
            const modal = document.getElementById('equipmentModal');
            if (modal) modal.remove();
            editingEquipment = null;
        }

        function saveEquipment() {
            const name = document.getElementById('equipmentName').value.trim();
            
            if (!name) {
                alert('אנא הכנס שם לפריט הציוד');
                return;
            }
            
            if (editingEquipment) {
                // Update existing equipment
                const index = equipment.findIndex(e => e.id === editingEquipment.id);
                equipment[index] = {
                    ...editingEquipment,
                    name
                };
            } else {
                // Add new equipment
                const newId = Math.max(...equipment.map(e => e.id), 0) + 1;
                equipment.push({
                    id: newId,
                    name
                });
            }
            
            closeEquipmentModal();
            renderEquipment();
        }

        function deleteEquipment(equipmentId) {
            if (!confirm('האם אתה בטוח שברצונך למחוק את הפריט?')) return;
            
            const index = equipment.findIndex(e => e.id === equipmentId);
            if (index > -1) {
                equipment.splice(index, 1);
                renderEquipment();
            }
        }

        // Payments Management Functions
        function setPaymentsViewMode(mode) {
            paymentsViewMode = mode;
            
            // Update button styles
            document.getElementById('paymentsViewPayments').className = mode === 'payments' 
                ? 'px-4 py-2 rounded-lg text-sm font-medium transition-all bg-green-600 text-white'
                : 'px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:text-gray-800';
            
            document.getElementById('paymentsViewExpenses').className = mode === 'expenses'
                ? 'px-4 py-2 rounded-lg text-sm font-medium transition-all bg-green-600 text-white'
                : 'px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:text-gray-800';
            
            renderPaymentsPage();
        }

        function renderPaymentsPage() {
            if (paymentsViewMode === 'payments') {
                document.getElementById('paymentsContainer').classList.remove('hidden');
                document.getElementById('expensesContainer').classList.add('hidden');
                renderPayments();
            } else {
                document.getElementById('paymentsContainer').classList.add('hidden');
                document.getElementById('expensesContainer').classList.remove('hidden');
                renderExpenses();
            }
        }

        function renderPayments() {
            const container = document.getElementById('paymentsContainer');
            
            // Get events that have payments or need payments
            const eventsWithPayments = events.map(event => {
                const payment = payments.find(p => p.eventId === event.id) || {
                    eventId: event.id,
                    keyboardistPaid: false,
                    keyboardistDate: "",
                    keyboardistMethod: "",
                    drummersPaid: false,
                    drummersDate: "",
                    drummersMethod: "",
                    managerPaid: false,
                    managerDate: "",
                    managerMethod: ""
                };
                return { event, payment };
            });

            if (eventsWithPayments.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">💰</div>
                        <h3 class="text-xl font-bold text-gray-600 mb-2">לא נמצאו אירועים</h3>
                        <p class="text-gray-500">הוסף אירועים כדי לנהל תשלומים</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = eventsWithPayments.map(({ event, payment }, index) => {
                const gradientClass = `card-gradient-${(index % 6) + 1}`;
                const eventDate = new Date(event.date);
                const formattedDate = eventDate.toLocaleDateString('he-IL', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });

                // Calculate payment status
                const totalPayments = (event.keyboardist ? 1 : 0) + (event.drummers > 0 ? 1 : 0) + 1; // +1 for manager
                const completedPayments = (payment.keyboardistPaid && event.keyboardist ? 1 : 0) + 
                                        (payment.drummersPaid && event.drummers > 0 ? 1 : 0) + 
                                        (payment.managerPaid ? 1 : 0);

                return `
                    <div class="bg-white border border-gray-200 rounded-3xl shadow-lg hover:shadow-xl transition-all duration-300 overflow-hidden">
                        <div class="${gradientClass} p-4 text-white cursor-pointer" onclick="togglePaymentDetails('payment-${event.id}')">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center">
                                    <span class="text-2xl ml-3">💰</span>
                                    <div>
                                        <h3 class="text-lg font-bold">${event.name}</h3>
                                        <p class="text-sm opacity-90">${formattedDate}</p>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2 space-x-reverse">
                                    <span class="bg-white bg-opacity-20 text-white px-3 py-1 rounded-full text-xs font-medium">
                                        ${completedPayments}/${totalPayments} שולם
                                    </span>
                                    <button onclick="event.stopPropagation(); editPayments(${event.id})" class="bg-white bg-opacity-20 text-white px-3 py-1 rounded-lg text-sm hover:bg-opacity-30 transition-colors">
                                        ✏️ עדכן
                                    </button>
                                    <span id="payment-arrow-${event.id}" class="text-white text-xl transition-transform duration-300">▼</span>
                                </div>
                            </div>
                        </div>

                        <div id="payment-details-${event.id}" class="hidden p-4 space-y-3">
                            <!-- Manager Payment -->
                            <div class="bg-purple-50 p-3 rounded-xl border border-purple-200">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <span class="text-lg ml-2">👩‍💼</span>
                                        <span class="font-bold text-purple-700">מנהלת האירוע</span>
                                    </div>
                                    <div class="flex items-center">
                                        ${payment.managerPaid ? `
                                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium ml-2">✅ שולם</span>
                                        ` : `
                                            <span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-medium ml-2">❌ לא שולם</span>
                                        `}
                                    </div>
                                </div>
                                ${payment.managerPaid ? `
                                    <div class="mt-2 text-xs text-purple-600">
                                        <div>📅 ${new Date(payment.managerDate).toLocaleDateString('he-IL')}</div>
                                        <div>💳 ${payment.managerMethod}</div>
                                    </div>
                                ` : ''}
                            </div>

                            <!-- Keyboardist Payment -->
                            ${event.keyboardist ? `
                            <div class="bg-blue-50 p-3 rounded-xl border border-blue-200">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <span class="text-lg ml-2">🎹</span>
                                        <span class="font-bold text-blue-700">קלידן</span>
                                    </div>
                                    <div class="flex items-center">
                                        ${payment.keyboardistPaid ? `
                                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium ml-2">✅ שולם</span>
                                        ` : `
                                            <span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-medium ml-2">❌ לא שולם</span>
                                        `}
                                    </div>
                                </div>
                                ${payment.keyboardistPaid ? `
                                    <div class="mt-2 text-xs text-blue-600">
                                        <div>📅 ${new Date(payment.keyboardistDate).toLocaleDateString('he-IL')}</div>
                                        <div>💳 ${payment.keyboardistMethod}</div>
                                    </div>
                                ` : ''}
                            </div>
                            ` : ''}

                            <!-- Drummers Payment -->
                            ${event.drummers > 0 ? `
                            <div class="bg-orange-50 p-3 rounded-xl border border-orange-200">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <span class="text-lg ml-2">🥁</span>
                                        <span class="font-bold text-orange-700">מתופפים (${event.drummers})</span>
                                    </div>
                                    <div class="flex items-center">
                                        ${payment.drummersPaid ? `
                                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium ml-2">✅ שולם</span>
                                        ` : `
                                            <span class="bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs font-medium ml-2">❌ לא שולם</span>
                                        `}
                                    </div>
                                </div>
                                ${payment.drummersPaid ? `
                                    <div class="mt-2 text-xs text-orange-600">
                                        <div>📅 ${new Date(payment.drummersDate).toLocaleDateString('he-IL')}</div>
                                        <div>💳 ${payment.drummersMethod}</div>
                                    </div>
                                ` : ''}
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function togglePaymentDetails(paymentId) {
            const detailsElement = document.getElementById(`payment-details-${paymentId.replace('payment-', '')}`);
            const arrowElement = document.getElementById(`payment-arrow-${paymentId.replace('payment-', '')}`);
            
            if (detailsElement.classList.contains('hidden')) {
                detailsElement.classList.remove('hidden');
                arrowElement.style.transform = 'rotate(180deg)';
            } else {
                detailsElement.classList.add('hidden');
                arrowElement.style.transform = 'rotate(0deg)';
            }
        }

        function editPayments(eventId) {
            const event = events.find(e => e.id === eventId);
            if (!event) return;

            const payment = payments.find(p => p.eventId === eventId) || {
                eventId: eventId,
                keyboardistPaid: false,
                keyboardistDate: "",
                keyboardistMethod: "",
                drummersPaid: false,
                drummersDate: "",
                drummersMethod: "",
                managerPaid: false,
                managerDate: "",
                managerMethod: ""
            };

            const modalHtml = `
                <div id="paymentsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full max-h-[85vh] overflow-y-auto">
                        <div class="bg-gradient-to-l from-green-600 to-emerald-600 text-white p-6 rounded-t-3xl">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold">עדכון תשלומים</h3>
                                <button onclick="closePaymentsModal()" class="text-white hover:text-gray-200 text-2xl font-bold">×</button>
                            </div>
                            <p class="text-green-100 text-sm mt-1">אירוע: ${event.name}</p>
                        </div>
                        
                        <div class="p-4 space-y-4">
                            <!-- Manager Payment -->
                            <div class="bg-purple-50 p-4 rounded-xl border border-purple-200">
                                <div class="flex items-center mb-3">
                                    <span class="text-lg ml-2">👩‍💼</span>
                                    <span class="font-bold text-purple-700">מנהלת האירוע</span>
                                </div>
                                
                                <div class="flex items-center mb-3">
                                    <input type="checkbox" id="managerPaid" ${payment.managerPaid ? 'checked' : ''} class="ml-2 w-4 h-4 text-purple-600 bg-gray-100 border-gray-300 rounded focus:ring-purple-500">
                                    <label for="managerPaid" class="text-sm font-medium text-gray-700">התשלום בוצע</label>
                                </div>
                                
                                <div id="managerDetails" class="${payment.managerPaid ? '' : 'hidden'} space-y-3">
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-1">תאריך התשלום</label>
                                        <input type="date" id="managerDate" value="${payment.managerDate}" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-1">אופן התשלום</label>
                                        <select id="managerMethod" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-sm">
                                            <option value="מזומן" ${payment.managerMethod === 'מזומן' ? 'selected' : ''}>מזומן</option>
                                            <option value="העברה בנקאית" ${payment.managerMethod === 'העברה בנקאית' ? 'selected' : ''}>העברה בנקאית</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Keyboardist Payment -->
                            ${event.keyboardist ? `
                            <div class="bg-blue-50 p-4 rounded-xl border border-blue-200">
                                <div class="flex items-center mb-3">
                                    <span class="text-lg ml-2">🎹</span>
                                    <span class="font-bold text-blue-700">קלידן</span>
                                </div>
                                
                                <div class="flex items-center mb-3">
                                    <input type="checkbox" id="keyboardistPaid" ${payment.keyboardistPaid ? 'checked' : ''} class="ml-2 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                                    <label for="keyboardistPaid" class="text-sm font-medium text-gray-700">התשלום בוצע</label>
                                </div>
                                
                                <div id="keyboardistDetails" class="${payment.keyboardistPaid ? '' : 'hidden'} space-y-3">
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-1">תאריך התשלום</label>
                                        <input type="date" id="keyboardistDate" value="${payment.keyboardistDate}" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-1">אופן התשלום</label>
                                        <select id="keyboardistMethod" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm">
                                            <option value="מזומן" ${payment.keyboardistMethod === 'מזומן' ? 'selected' : ''}>מזומן</option>
                                            <option value="העברה בנקאית" ${payment.keyboardistMethod === 'העברה בנקאית' ? 'selected' : ''}>העברה בנקאית</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            ` : ''}

                            <!-- Drummers Payment -->
                            ${event.drummers > 0 ? `
                            <div class="bg-orange-50 p-4 rounded-xl border border-orange-200">
                                <div class="flex items-center mb-3">
                                    <span class="text-lg ml-2">🥁</span>
                                    <span class="font-bold text-orange-700">מתופפים (${event.drummers})</span>
                                </div>
                                
                                <div class="flex items-center mb-3">
                                    <input type="checkbox" id="drummersPaid" ${payment.drummersPaid ? 'checked' : ''} class="ml-2 w-4 h-4 text-orange-600 bg-gray-100 border-gray-300 rounded focus:ring-orange-500">
                                    <label for="drummersPaid" class="text-sm font-medium text-gray-700">התשלום בוצע</label>
                                </div>
                                
                                <div id="drummersDetails" class="${payment.drummersPaid ? '' : 'hidden'} space-y-3">
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-1">תאריך התשלום</label>
                                        <input type="date" id="drummersDate" value="${payment.drummersDate}" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-gray-700 mb-1">אופן התשלום</label>
                                        <select id="drummersMethod" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent text-sm">
                                            <option value="מזומן" ${payment.drummersMethod === 'מזומן' ? 'selected' : ''}>מזומן</option>
                                            <option value="העברה בנקאית" ${payment.drummersMethod === 'העברה בנקאית' ? 'selected' : ''}>העברה בנקאית</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- Action Buttons -->
                            <div class="flex gap-3 pt-4">
                                <button onclick="savePayments(${eventId})" class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 text-white px-6 py-3 rounded-xl hover:from-green-700 hover:to-emerald-700 transition-all font-medium">
                                    שמור שינויים
                                </button>
                                <button onclick="closePaymentsModal()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-all font-medium">
                                    ביטול
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // Add event listeners for checkboxes
            document.getElementById('managerPaid').addEventListener('change', function() {
                const details = document.getElementById('managerDetails');
                if (this.checked) {
                    details.classList.remove('hidden');
                    if (!document.getElementById('managerDate').value) {
                        document.getElementById('managerDate').value = new Date().toISOString().split('T')[0];
                    }
                } else {
                    details.classList.add('hidden');
                }
            });

            if (event.keyboardist) {
                document.getElementById('keyboardistPaid').addEventListener('change', function() {
                    const details = document.getElementById('keyboardistDetails');
                    if (this.checked) {
                        details.classList.remove('hidden');
                        if (!document.getElementById('keyboardistDate').value) {
                            document.getElementById('keyboardistDate').value = new Date().toISOString().split('T')[0];
                        }
                    } else {
                        details.classList.add('hidden');
                    }
                });
            }

            if (event.drummers > 0) {
                document.getElementById('drummersPaid').addEventListener('change', function() {
                    const details = document.getElementById('drummersDetails');
                    if (this.checked) {
                        details.classList.remove('hidden');
                        if (!document.getElementById('drummersDate').value) {
                            document.getElementById('drummersDate').value = new Date().toISOString().split('T')[0];
                        }
                    } else {
                        details.classList.add('hidden');
                    }
                });
            }
        }

        function closePaymentsModal() {
            const modal = document.getElementById('paymentsModal');
            if (modal) modal.remove();
        }

        function savePayments(eventId) {
            const managerPaid = document.getElementById('managerPaid').checked;
            const managerDate = document.getElementById('managerDate').value;
            const managerMethod = document.getElementById('managerMethod').value;

            const keyboardistPaid = document.getElementById('keyboardistPaid') ? document.getElementById('keyboardistPaid').checked : false;
            const keyboardistDate = document.getElementById('keyboardistDate') ? document.getElementById('keyboardistDate').value : "";
            const keyboardistMethod = document.getElementById('keyboardistMethod') ? document.getElementById('keyboardistMethod').value : "";

            const drummersPaid = document.getElementById('drummersPaid') ? document.getElementById('drummersPaid').checked : false;
            const drummersDate = document.getElementById('drummersDate') ? document.getElementById('drummersDate').value : "";
            const drummersMethod = document.getElementById('drummersMethod') ? document.getElementById('drummersMethod').value : "";

            // Find existing payment or create new one
            let paymentIndex = payments.findIndex(p => p.eventId === eventId);
            
            const paymentData = {
                eventId: eventId,
                managerPaid,
                managerDate: managerPaid ? managerDate : "",
                managerMethod: managerPaid ? managerMethod : "",
                keyboardistPaid,
                keyboardistDate: keyboardistPaid ? keyboardistDate : "",
                keyboardistMethod: keyboardistPaid ? keyboardistMethod : "",
                drummersPaid,
                drummersDate: drummersPaid ? drummersDate : "",
                drummersMethod: drummersPaid ? drummersMethod : ""
            };

            if (paymentIndex > -1) {
                // Update existing payment
                payments[paymentIndex] = { ...payments[paymentIndex], ...paymentData };
            } else {
                // Create new payment
                const newId = Math.max(...payments.map(p => p.id), 0) + 1;
                payments.push({ id: newId, ...paymentData });
            }

            closePaymentsModal();
            renderPayments();
        }

        function renderExpenses() {
            const container = document.getElementById('expensesContainer');
            
            if (expenses.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">📊</div>
                        <h3 class="text-xl font-bold text-gray-600 mb-2">לא נמצאו הוצאות</h3>
                        <p class="text-gray-500">השתמש בכפתור "הוסף הוצאה" כדי להתחיל</p>
                    </div>
                `;
                return;
            }

            // Calculate total expenses
            const totalExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);

            // Group expenses by category
            const categories = {};
            expenses.forEach(expense => {
                if (!categories[expense.category]) {
                    categories[expense.category] = { total: 0, items: [] };
                }
                categories[expense.category].total += expense.amount;
                categories[expense.category].items.push(expense);
            });

            container.innerHTML = `
                <div class="mb-6 flex justify-between items-center">
                    <button onclick="showAddExpenseForm()" class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-3 rounded-2xl hover:from-blue-700 hover:to-indigo-700 transition-all shadow-lg flex items-center">
                        <span class="ml-2">➕</span>
                        <span class="font-medium">הוסף הוצאה</span>
                    </button>
                    <div class="bg-gradient-to-r from-red-500 to-pink-600 text-white px-6 py-3 rounded-2xl shadow-lg">
                        <span class="font-bold">סה"כ הוצאות: ₪${totalExpenses.toLocaleString()}</span>
                    </div>
                </div>
                
                <div class="space-y-6">
                    ${Object.keys(categories).map((category, categoryIndex) => {
                        const categoryGradient = `card-gradient-${(categoryIndex % 6) + 1}`;
                        const categoryData = categories[category];
                        
                        return `
                            <div class="bg-white border border-gray-200 rounded-3xl shadow-lg overflow-hidden">
                                <div class="${categoryGradient} p-4 text-white">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <span class="text-2xl ml-3">📊</span>
                                            <div>
                                                <h3 class="text-lg font-bold">${category}</h3>
                                                <p class="text-sm opacity-90">${categoryData.items.length} פריטים</p>
                                            </div>
                                        </div>
                                        <div class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-full font-bold">
                                            ₪${categoryData.total.toLocaleString()}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="p-4 space-y-3">
                                    ${categoryData.items.map(expense => {
                                        const expenseDate = new Date(expense.date);
                                        const formattedDate = expenseDate.toLocaleDateString('he-IL', {
                                            day: 'numeric',
                                            month: 'long',
                                            year: 'numeric'
                                        });
                                        
                                        const relatedEvent = expense.eventId ? events.find(e => e.id === expense.eventId) : null;
                                        
                                        return `
                                            <div class="bg-gray-50 p-3 rounded-xl border border-gray-200">
                                                <div class="flex items-center justify-between">
                                                    <div class="flex-1">
                                                        <div class="font-bold text-gray-800 mb-1">${expense.description}</div>
                                                        <div class="text-sm text-gray-600 mb-1">📅 ${formattedDate}</div>
                                                        ${relatedEvent ? `<div class="text-xs text-blue-600">🎊 קשור לאירוע: ${relatedEvent.name}</div>` : ''}
                                                    </div>
                                                    <div class="flex items-center gap-2">
                                                        <span class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-3 py-1 rounded-full text-sm font-bold">
                                                            ₪${expense.amount.toLocaleString()}
                                                        </span>
                                                        <button onclick="editExpense(${expense.id})" class="bg-blue-600 text-white px-2 py-1 rounded text-xs hover:bg-blue-700 transition-colors">
                                                            ✏️
                                                        </button>
                                                        <button onclick="deleteExpense(${expense.id})" class="bg-red-600 text-white px-2 py-1 rounded text-xs hover:bg-red-700 transition-colors">
                                                            🗑️
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        let editingExpense = null;

        function showAddExpenseForm() {
            editingExpense = null;
            showExpenseModal();
        }

        function editExpense(expenseId) {
            editingExpense = expenses.find(e => e.id === expenseId);
            showExpenseModal();
        }

        function showExpenseModal() {
            const isEditing = editingExpense !== null;
            const expense = editingExpense || { 
                date: new Date().toISOString().split('T')[0], 
                category: '', 
                description: '', 
                amount: 0, 
                eventId: null 
            };
            
            const modalHtml = `
                <div id="expenseModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full">
                        <div class="bg-gradient-to-l from-blue-600 to-indigo-600 text-white p-6 rounded-t-3xl">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold">${isEditing ? 'עריכת הוצאה' : 'הוספת הוצאה חדשה'}</h3>
                                <button onclick="closeExpenseModal()" class="text-white hover:text-gray-200 text-2xl font-bold">×</button>
                            </div>
                        </div>
                        
                        <div class="p-4 space-y-3">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">תאריך</label>
                                    <input type="date" id="expenseDate" value="${expense.date}" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">סכום (₪)</label>
                                    <input type="number" id="expenseAmount" value="${expense.amount}" min="0" step="0.01" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">קטגוריה</label>
                                <select id="expenseCategory" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">בחר קטגוריה</option>
                                    <option value="נסיעות" ${expense.category === 'נסיעות' ? 'selected' : ''}>נסיעות</option>
                                    <option value="ציוד" ${expense.category === 'ציוד' ? 'selected' : ''}>ציוד</option>
                                    <option value="פרסום" ${expense.category === 'פרסום' ? 'selected' : ''}>פרסום</option>
                                    <option value="תחזוקה" ${expense.category === 'תחזוקה' ? 'selected' : ''}>תחזוקה</option>
                                    <option value="משרד" ${expense.category === 'משרד' ? 'selected' : ''}>משרד</option>
                                    <option value="אחר" ${expense.category === 'אחר' ? 'selected' : ''}>אחר</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">תיאור</label>
                                <input type="text" id="expenseDescription" value="${expense.description}" placeholder="תיאור ההוצאה" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">קשור לאירוע (אופציונלי)</label>
                                <select id="expenseEventId" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">לא קשור לאירוע ספציפי</option>
                                    ${events.map(event => `
                                        <option value="${event.id}" ${expense.eventId === event.id ? 'selected' : ''}>${event.name} - ${new Date(event.date).toLocaleDateString('he-IL')}</option>
                                    `).join('')}
                                </select>
                            </div>
                            
                            <div class="flex gap-3 pt-4">
                                <button onclick="saveExpense()" class="flex-1 bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-6 py-3 rounded-xl hover:from-blue-700 hover:to-indigo-700 transition-all font-medium">
                                    ${isEditing ? 'עדכן הוצאה' : 'הוסף הוצאה'}
                                </button>
                                <button onclick="closeExpenseModal()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-all font-medium">
                                    ביטול
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeExpenseModal() {
            const modal = document.getElementById('expenseModal');
            if (modal) modal.remove();
            editingExpense = null;
        }

        function saveExpense() {
            const date = document.getElementById('expenseDate').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
            const category = document.getElementById('expenseCategory').value;
            const description = document.getElementById('expenseDescription').value.trim();
            const eventId = document.getElementById('expenseEventId').value || null;
            
            if (!date || !category || !description || amount <= 0) {
                alert('אנא מלא את כל השדות הנדרשים');
                return;
            }
            
            if (editingExpense) {
                // Update existing expense
                const index = expenses.findIndex(e => e.id === editingExpense.id);
                expenses[index] = {
                    ...editingExpense,
                    date, amount, category, description, eventId: eventId ? parseInt(eventId) : null
                };
            } else {
                // Add new expense
                const newId = Math.max(...expenses.map(e => e.id), 0) + 1;
                expenses.push({
                    id: newId,
                    date, amount, category, description, eventId: eventId ? parseInt(eventId) : null
                });
            }
            
            closeExpenseModal();
            renderExpenses();
        }

        function deleteExpense(expenseId) {
            if (!confirm('האם אתה בטוח שברצונך למחוק את ההוצאה?')) return;
            
            const index = expenses.findIndex(e => e.id === expenseId);
            if (index > -1) {
                expenses.splice(index, 1);
                renderExpenses();
            }
        }

        // Useful Links Management Functions
        function renderUsefulLinks() {
            const container = document.getElementById('usefulLinksContainer');
            
            if (usefulLinks.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-6xl mb-4">🔗</div>
                        <h3 class="text-xl font-bold text-gray-600 mb-2">לא נמצאו קישורים</h3>
                        <p class="text-gray-500">השתמש בכפתור "הוסף קישור" כדי להתחיל</p>
                    </div>
                `;
                return;
            }

            // Group links by category
            const categories = {};
            usefulLinks.forEach(link => {
                if (!categories[link.category]) {
                    categories[link.category] = [];
                }
                categories[link.category].push(link);
            });

            let html = '';
            Object.keys(categories).forEach((category, categoryIndex) => {
                const categoryGradient = `card-gradient-${(categoryIndex % 6) + 1}`;
                html += `
                    <div class="mb-6">
                        <div class="${categoryGradient} p-4 rounded-2xl text-white mb-4">
                            <h3 class="text-xl font-bold">${category}</h3>
                        </div>
                        <div class="space-y-3 mr-4">
                            ${categories[category].map((link, index) => `
                                <div class="bg-white border border-gray-200 rounded-2xl shadow-md hover:shadow-lg transition-all duration-300 overflow-hidden">
                                    <div class="p-4">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center flex-1">
                                                <span class="text-2xl ml-3">${link.icon}</span>
                                                <div class="flex-1">
                                                    <h4 class="font-bold text-gray-800 mb-1">${link.name}</h4>
                                                    <p class="text-sm text-gray-600 mb-2">${link.description}</p>
                                                    <button onclick="openLink('${link.url}')" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-4 py-2 rounded-xl hover:from-indigo-700 hover:to-purple-700 transition-all text-sm font-medium shadow-md">
                                                        🔗 פתח קישור
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="flex gap-2">
                                                <button onclick="editLink(${link.id})" class="bg-blue-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-blue-700 transition-colors">
                                                    ✏️ עריכה
                                                </button>
                                                <button onclick="deleteLink(${link.id})" class="bg-red-600 text-white px-3 py-1 rounded-lg text-sm hover:bg-red-700 transition-colors">
                                                    🗑️ מחק
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function showAddLinkForm() {
            editingLink = null;
            showLinkModal();
        }

        function editLink(linkId) {
            editingLink = usefulLinks.find(l => l.id === linkId);
            showLinkModal();
        }

        function showLinkModal() {
            const isEditing = editingLink !== null;
            const link = editingLink || { name: '', url: '', description: '', category: '', icon: '🔗' };
            
            const modalHtml = `
                <div id="linkModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full max-h-[85vh] overflow-y-auto">
                        <div class="bg-gradient-to-l from-indigo-600 to-purple-600 text-white p-6 rounded-t-3xl">
                            <div class="flex justify-between items-center">
                                <h3 class="text-xl font-bold">${isEditing ? 'עריכת קישור' : 'הוספת קישור חדש'}</h3>
                                <button onclick="closeLinkModal()" class="text-white hover:text-gray-200 text-2xl font-bold">×</button>
                            </div>
                        </div>
                        
                        <div class="p-4 space-y-3">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">שם הקישור</label>
                                <input type="text" id="linkName" value="${link.name}" placeholder="לדוגמה: הנפקת חשבוניות" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">כתובת הקישור</label>
                                <input type="url" id="linkUrl" value="${link.url}" placeholder="https://example.com" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">תיאור</label>
                                <input type="text" id="linkDescription" value="${link.description}" placeholder="תיאור קצר של הקישור" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">קטגוריה</label>
                                    <input type="text" id="linkCategory" value="${link.category}" placeholder="לדוגמה: כספים" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-gray-700 mb-2">אייקון</label>
                                    <input type="text" id="linkIcon" value="${link.icon}" placeholder="🔗" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                                </div>
                            </div>
                            
                            <div class="flex gap-3 pt-4">
                                <button onclick="saveLink()" class="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-6 py-3 rounded-xl hover:from-indigo-700 hover:to-purple-700 transition-all font-medium">
                                    ${isEditing ? 'עדכן קישור' : 'הוסף קישור'}
                                </button>
                                <button onclick="closeLinkModal()" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition-all font-medium">
                                    ביטול
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        function closeLinkModal() {
            const modal = document.getElementById('linkModal');
            if (modal) modal.remove();
            editingLink = null;
        }

        function saveLink() {
            const name = document.getElementById('linkName').value.trim();
            const url = document.getElementById('linkUrl').value.trim();
            const description = document.getElementById('linkDescription').value.trim();
            const category = document.getElementById('linkCategory').value.trim();
            const icon = document.getElementById('linkIcon').value.trim() || '🔗';
            
            if (!name || !url || !description || !category) {
                alert('אנא מלא את כל השדות הנדרשים');
                return;
            }
            
            if (editingLink) {
                // Update existing link
                const index = usefulLinks.findIndex(l => l.id === editingLink.id);
                usefulLinks[index] = {
                    ...editingLink,
                    name, url, description, category, icon
                };
            } else {
                // Add new link
                const newId = Math.max(...usefulLinks.map(l => l.id), 0) + 1;
                usefulLinks.push({
                    id: newId,
                    name, url, description, category, icon
                });
            }
            
            closeLinkModal();
            renderUsefulLinks();
        }

        function deleteLink(linkId) {
            if (!confirm('האם אתה בטוח שברצונך למחוק את הקישור?')) return;
            
            const index = usefulLinks.findIndex(l => l.id === linkId);
            if (index > -1) {
                usefulLinks.splice(index, 1);
                renderUsefulLinks();
            }
        }

        function openLink(url) {
            window.open(url, '_blank');
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96a172b584968e4b',t:'MTc1NDM0NjA5MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
